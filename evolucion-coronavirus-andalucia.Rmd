---
title: "Evolución del coronavirus (COVID-19) en Andalucía"
output: 
  html_document: 
    fig_caption: yes
    fig_height: 5
    fig_width: 7
    theme: flatly
    toc: no
    self_contained: no
    includes: 
      in_header: header.html
---

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-46538450-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-46538450-3');
</script>



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

# Garrick Adenbuie's gist to place TOC anywhere
# devtools::source_gist("c83e078bf8c81b035e32c3fc0cf04ee8", 
#                       filename = 'render_toc.R')
source("render_toc.R")
```

```{r pkgs, include=FALSE}
library(dplyr)
library(ggplot2)
#library(plotly)

mytheme <- theme_minimal(base_size = 12) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.caption = element_text(size = 7, face = "italic", colour = "grey60"),
        axis.ticks = element_line(colour = "grey80"),
        axis.ticks.length = unit(3, "pt"))
theme_set(mytheme)
```

<br>

Aquí se visualiza la evolución de la enfermedad del coronavirus (COVID-19) en Andalucía, según los [datos oficiales ofrecidos por la Consejería de Salud y Familias](https://www.juntadeandalucia.es/organismos/saludyfamilias/areas/salud-vida/paginas/Nuevo_Coronavirus.html). A diferencia de otras visualizaciones más extendidas, que representan datos acumulados en el tiempo, aquí se enfatizan las **variaciones diarias absolutas (no acumuladas)** en número de casos, personas ingresadas, curadas y número de fallecimientos.

Los datos se actualizan diariamente. Tanto los datos como el código empleado para generar estas visualizaciones está disponible [aquí](https://github.com/Pakillo/COVID19-Andalucia).

Última actualización: `r Sys.Date()`

```{r}
render_toc("evolucion-coronavirus-andalucia.Rmd", base_level = 2, toc_depth = 1)
```




```{r}
datos <- readxl::read_excel("datos_brutos.xlsx", sheet = "datos")
```

```{r}
datos <- datos %>%
  group_by(Provincia) %>%
  mutate(Positivos.dia = Positivos.acum - lag(Positivos.acum),
         Ingresos.dia = Ingresos.acum - lag(Ingresos.acum),
         UCI.dia = UCI.acum - lag(UCI.acum),
         Fallecimientos.dia = Fallecimientos.acum - lag(Fallecimientos.acum),
         Altas.dia = Altas.acum - lag(Altas.acum),
         Curadas.dia = Curadas.acum - lag(Curadas.acum))

## Before 22 March, not clear if hospitalizations are accumulated or not (many negative variations in some provinces!)
# Set them to NA seems the safest strategy by now
datos <- datos %>%
  mutate(Ingresos.dia = ifelse(Ingresos.dia < 0, NA, Ingresos.dia))


# checks
stopifnot(na.omit(datos$Positivos.dia >= 0))
stopifnot(na.omit(datos$Ingresos.dia >= 0))
stopifnot(na.omit(datos$UCI.dia >= 0))
stopifnot(na.omit(datos$Curadas.dia >= 0))
stopifnot(na.omit(datos$Fallecimientos.dia >= 0))


```


```{r}
andal <- datos %>%
  group_by(Fecha) %>%
  summarise(Positivos.dia = sum(Positivos.dia),
            Ingresos.acum = sum(Ingresos.acum),
            Ingresos.dia = sum(Ingresos.dia),
            UCI.acum = sum(UCI.acum),
            UCI.dia = sum(UCI.dia),
            Seguimiento = sum(Seguimiento),
            Fallecimientos.dia = sum(Fallecimientos.dia),
            Altas.dia = sum(Altas.dia),
            Curadas.dia = sum(Curadas.dia))


prop.ci <- function(pos, n) {
  # from Gelman & Hill book, p. 18
  estimate <- pos/n
  se <- sqrt(estimate * (1 - estimate) / n)
  int.99 <- estimate + qnorm(c(.005,.995)) * se
  int.99

}


test.andal <- readxl::read_excel("datos_brutos.xlsx", sheet = "test-Andal")

andal <- andal %>%
  left_join(test.andal[, c("Fecha", "Ntest.dia")], by = "Fecha") %>%
  group_by(Fecha) %>%
  mutate(Prop.positivos = 100 * (Positivos.dia / Ntest.dia),
         prop.ci.low = 100 * prop.ci(Positivos.dia, Ntest.dia)[1],
         prop.ci.up = 100 * prop.ci(Positivos.dia, Ntest.dia)[2])

```

<br>

## Casos confirmados

<br>

```{r casos_Andalucía, fig.height=4, out.width='100%'}

ggplot(andal) +
  geom_col(aes(x = Fecha, y = Positivos.dia), 
            fill = "#ff7f00") +
  geom_line(aes(x = Fecha, y = Ntest.dia), 
            size = 1, colour = "grey70") + 
  scale_y_continuous(limits = c(0, max(andal$Ntest.dia)),
                     n.breaks = 6) +
  scale_x_datetime(limits = c(min(andal$Fecha[!is.na(andal$Positivos.dia)]),
                          max(andal$Fecha))) +
  labs(x = "", y = "Nuevas detecciones\n",
       title = "Nuevos casos de COVID-19 confirmados diariamente en Andalucía",
       caption = "La línea gris representa el número de test realizados diariamente") +
    theme(plot.caption = element_text(size = 9, colour = "grey60", face = "plain")) +
  theme(panel.grid.minor.y = element_line(size = rel(0.5)))

```

<br>

Debe tenerse en cuenta que el número de casos confirmados depende en gran medida del número de test realizados. Por tanto, un aumento o disminución en el número de casos confirmados cada día puede deberse a haber realizado más o menos tests, no a variaciones en la incidencia de la enfermedad.

<br>



```{r out.width='100%'}
ggplot(andal) +
  geom_point(aes(Ntest.dia, Positivos.dia), 
             size = 3, colour = "#ff7f00") +
  scale_y_continuous(limits = c(0, NA), 
                     name = "Número de casos confirmados\n") +
  scale_x_continuous(limits = c(0, NA),
                     name = "\nNúmero de test realizados") +
  labs(title = "Relación entre el número de casos confirmados\ny el número de test realizados diariamente")
```

<br>
<br>

La proporción de casos positivos respecto al total de test realizados también puede informarnos sobre la incidencia de la enfermedad: 

<br>

```{r prop.positivos, fig.height=3.2, out.width = '100%'}

sec.axis.factor = 30

ggplot(andal) +
  # geom_ribbon(aes(x = Fecha, ymin = prop.ci.low, ymax = prop.ci.up),
  #             fill = "#ff7f00", alpha = 0.3) +
  geom_col(aes(x = Fecha, y = Prop.positivos), 
            size = 2, fill = "#ff7f00") +
  geom_line(aes(x = Fecha, y = (Ntest.dia/sec.axis.factor)), 
            colour = "grey70", size = 1.5) +
  # geom_text(aes(x = Fecha, y = 5, label = Ntest.dia), 
  #           colour = "#ff7f00", alpha = 0.8) +
  scale_y_continuous(limits = c(0, 100), #max(andal$Prop.positivos, na.rm = TRUE)),
                     sec.axis = sec_axis(trans = ~ ((.*sec.axis.factor)), 
                                         breaks = seq(0, 3000, by = 500),
                                         name = "Número de test\n")) +
  scale_x_datetime(limits = c(as.POSIXct("2020-03-30", tz = "UTC"),
                          max(andal$Fecha))) +
  labs(x = "", y = "Porcentaje de tests positivos\n",
       title = "Porcentaje de tests que dan positivo en Andalucía",
       caption = "La línea gris representa el número de test realizados diariamente (eje derecho)") +
  theme(plot.caption = element_text(size = 9, colour = "grey60", face = "plain"))


```


<br>
<br>

```{r casos_provincias, out.width = '100%'}

ggplot(datos) +
  facet_wrap(~Provincia, scales = "free_y", ncol = 2) +
  geom_col(aes(x = Fecha, y = Positivos.dia), 
            size = 1.5, fill = "#ff7f00") +
  ylim(0, max(datos$Positivos.dia)) +
  scale_x_datetime(limits = c(min(datos$Fecha[!is.na(datos$Positivos.dia)]),
                          max(datos$Fecha))) +
  labs(x = "", y = "Nuevas detecciones\n",
       title = "Nuevos casos de COVID-19 confirmados diariamente por provincia",
       caption = "Nótese que, para facilitar la visualización de tendencias, la escala del eje vertical varía para cada provincia") +
  theme(axis.text.x = element_text(size = 8))

```


<br>


### Casos confirmados por Distrito Sanitario 


```{r}

distritos <- gsheet::gsheet2tbl("https://docs.google.com/spreadsheets/d/1vH3y_4bL9n1sXOQjA91m8eqfbpCI-a8KV3cWXfQY3cI")

distritos <- distritos %>%
  group_by(nombre) %>%
  mutate(casos.dia = confirmados - lag(confirmados)) %>%
  mutate(casos.dia = ifelse(fecha == as.Date("2020-04-11"), NA, casos.dia))

```


```{r eval=FALSE}
ggplot(distritos) +
  geom_line(aes(x = fecha, y = confirmados, 
                group = nombre, colour = provincia)) +
  theme(legend.position = "top", legend.title = element_blank()) +
  scale_y_log10()
  scale_x_datetime(limits = c(as.POSIXct("2020-04-11", tz = "UTC"), NA))

```

```{r out.width='100%', fig.height=7}
distritos.data <- dplyr::filter(distritos, fecha > "2020-04-11")
distritos.last <- dplyr::filter(distritos, fecha == max(fecha))

ggplot(distritos.data) +
  aes(x = fecha, y = casos.dia) +
  facet_wrap(~provincia, ncol = 2) +
  geom_line(aes(group = nombre, colour = nombre)) +
  geom_point(data = distritos.last, aes(colour = nombre)) +
  theme(legend.position = "none") +
  ggrepel::geom_text_repel(data = distritos.last,
                           aes(label = nombre, colour = nombre), 
                           size = 2, nudge_x = 0.4, 
                           segment.size = 0.2, segment.alpha = 0.5) +
  scale_x_date(expand = expansion(mult = c(0, 0.5))) +
  labs(x = "", y = "Casos confirmados\n")

```


Este mapa muestra los casos confirmados con fecha 6 de Abril. La Junta de Andalucía ha comenzado a visualizar los datos diarios por Distrito Sanitario [aquí](http://www.juntadeandalucia.es/institutodeestadisticaycartografia/salud/COVID19.html).

```{r mapa_distritos, out.width='100%'}
casos.dist <- readxl::read_excel("datos_brutos.xlsx", sheet = "distritos")

library(sf)

distritos <- st_read("Distritos/Distritos_2018.shp", 
                     stringsAsFactors = FALSE, quiet = TRUE) %>%
  mutate(CODIST = as.numeric(CODIST))

casos.dist <- left_join(select(distritos, CODIST, nombre),
                        select(casos.dist, CODIST, nombre, casos, fecha),
                        by = c("CODIST", "nombre"))


library(mapview)
mapviewOptions(legend.pos = "bottomleft")

mapview(casos.dist, zcol = "casos", 
        col.regions = colorRampPalette(RColorBrewer::brewer.pal(9, "YlOrRd")),
        alpha.regions = 0.9,
        map.types = "CartoDB.Positron",
        layer.name = "Casos",
        popup = leafpop::popupTable(casos.dist, 
                                    zcol = c("nombre", "casos", "fecha"), 
                           row.numbers = FALSE, feature.id = FALSE)) 

# ggplot(casos.dist) +
#   geom_sf(aes(fill = casos)) +
#   scale_fill_distiller(type = "seq", palette = "YlGnBu", direction = 1)
        
```




```{r seguimiento_Andalucía, fig.height=3, out.width='100%',eval=FALSE}

ggplot(andal) +
  geom_line(aes(x = Fecha, y = Seguimiento), 
            size = 2, colour = "#a65628") +
  ylim(0, max(andal$Seguimiento)) +
  scale_x_datetime(limits = c(min(andal$Fecha[!is.na(andal$Seguimiento)]),
                          max(andal$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Personas en seguimiento activo por COVID-19 en Andalucía")

```


```{r seguimiento_provincias, out.width='100%', eval=FALSE}

ggplot(datos) +
  facet_wrap(~Provincia, scales = "free_y", ncol = 2) +
  geom_line(aes(x = Fecha, y = Seguimiento), 
            size = 1.5, colour = "#a65628") +
  ylim(0, max(datos$Seguimiento)) +
  scale_x_datetime(limits = c(min(datos$Fecha[!is.na(datos$Seguimiento)]),
                          max(datos$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Personas en seguimiento activo en cada provincia",
       caption = "Nótese que, para facilitar la visualización de tendencias, la escala del eje vertical varía para cada provincia") +
  theme(axis.text.x = element_text(size = 8))

```


<br>


## Ingresos en centros hospitalarios

<br>


```{r ingresos_Andalucía, fig.height=3, out.width='100%'}

ggplot(andal) +
  geom_line(aes(x = Fecha, y = Ingresos.dia), 
            size = 2, colour = "#e41a1c") +
  ylim(0, max(andal$Ingresos.dia)) +
  scale_x_datetime(limits = c(min(andal$Fecha[!is.na(andal$Ingresos.dia)]),
                          max(andal$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Nuevos ingresos diarios con COVID-19 en Andalucía")

```


<br>
<br>


```{r ingresos_provincias, out.width='100%'}

ggplot(datos) +
  facet_wrap(~Provincia, scales = "free_y", ncol = 2) +
  geom_line(aes(x = Fecha, y = Ingresos.dia), 
            size = 1.5, colour = "#e41a1c") +
  ylim(0, max(datos$Ingresos.dia)) +
  scale_x_datetime(limits = c(as.POSIXct("2020-03-23", tz = "UTC"),
                          max(datos$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Nuevos ingresos diarios con COVID-19 en cada provincia",
       caption = "Nótese que, para facilitar la visualización de tendencias, la escala del eje vertical varía para cada provincia") +
  theme(axis.text.x = element_text(size = 8))

```


<br>


## Ingresos en cuidados intensivos (UCI)

<br>


```{r uci_Andalucía, fig.height=3, out.width='100%'}

ggplot(andal) +
  geom_line(aes(x = Fecha, y = UCI.dia), 
            size = 2, colour = "#a65628") +
  ylim(0, max(andal$UCI.dia)) +
  scale_x_datetime(limits = c(min(andal$Fecha[!is.na(andal$UCI.dia)]),
                          max(andal$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Ingresos diarios en cuidados intensivos en Andalucía")

```


<br>
<br>


```{r uci_provincias, out.width='100%', eval=FALSE}

ggplot(datos) +
  facet_wrap(~Provincia, scales = "free_y", ncol = 2) +
  geom_line(aes(x = Fecha, y = UCI.dia), 
            size = 1.5, colour = "#a65628") +
  ylim(0, max(datos$UCI.dia)) +
  scale_x_datetime(limits = c(min(datos$Fecha[!is.na(datos$UCI.dia)]),
                          max(datos$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Ingresos diarios en cuidados intensivos en cada provincia",
       caption = "Nótese que, para facilitar la visualización de tendencias, la escala del eje vertical varía para cada provincia") +
  theme(axis.text.x = element_text(size = 8))

```




```{r altas_Andalucía, fig.height=3, out.width='100%', eval=FALSE}

ggplot(andal) +
  geom_line(aes(x = Fecha, y = Altas.dia), 
            size = 2, colour = "#377eb8") +
  ylim(0, max(andal$Altas.dia)) +
  scale_x_datetime(limits = c(andal$Fecha[13],
                          max(andal$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Altas hospitalarias en Andalucía")

```



```{r altas_provincias, out.width='100%', eval=FALSE}

ggplot(datos) +
  facet_wrap(~Provincia, scales = "free_y", ncol = 2) +
  geom_line(aes(x = Fecha, y = Altas.dia), 
            size = 1.5, colour = "#377eb8") +
  ylim(0, max(datos$Altas.dia)) +
  scale_x_datetime(limits = c(andal$Fecha[13],
                          max(datos$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Altas hospitalarias en cada provincia",
       caption = "Nótese que, para facilitar la visualización de tendencias, la escala del eje vertical varía para cada provincia") +
  theme(axis.text.x = element_text(size = 8))

```


<br>


## Personas curadas

<br>


```{r curadas_Andalucía, fig.height=3, out.width='100%'}

ggplot(andal) +
  geom_line(aes(x = Fecha, y = Curadas.dia), 
            size = 2, colour = "#4daf4a") +
  ylim(0, max(andal$Curadas.dia)) +
  scale_x_datetime(limits = c(andal$Fecha[13],
                          max(andal$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Personas curadas de COVID-19 diariamente en Andalucía")

```


<br>
<br>


```{r curadas_provincias, out.width='100%', eval=FALSE}

ggplot(datos) +
  facet_wrap(~Provincia, scales = "free_y", ncol = 2) +
  geom_line(aes(x = Fecha, y = Curadas.dia), 
            size = 1.5, colour = "#4daf4a") +
  ylim(0, max(datos$Curadas.dia)) +
  scale_x_datetime(limits = c(andal$Fecha[13],
                          max(datos$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Personas curadas diariamente en cada provincia",
       caption = "Nótese que, para facilitar la visualización de tendencias, la escala del eje vertical varía para cada provincia") +
  theme(axis.text.x = element_text(size = 8))

```


<br>



## Fallecimientos

<br>

```{r fallecidos_Andalucia, fig.height=3, out.width='100%'}

ggplot(andal) +
  geom_line(aes(x = Fecha, y = Fallecimientos.dia), 
            size = 2, colour = "grey20") +
  labs(x = "", y = "Nº Fallecidos\n",
       title = "Fallecimientos diarios relacionados con COVID-19 en Andalucía") +
  scale_y_continuous(limits = c(0, max(andal$Fallecimientos.dia, na.rm = TRUE))) +
  scale_x_datetime(limits = c(min(andal$Fecha[!is.na(andal$Fallecimientos.dia)]),
                          max(andal$Fecha)))

```

<br>
<br>

```{r fallecidos_provincias, eval = TRUE, out.width='100%'}
         
ggplot(datos) +
  facet_wrap(~Provincia, ncol = 2, scales = "free_y") +  
  geom_line(aes(x = Fecha, y = Fallecimientos.dia), 
            size = 1.5, colour = "grey20") +
  scale_y_continuous(limits = c(0, max(datos$Fallecimientos.dia, na.rm = TRUE))) +
  scale_x_datetime(limits = c(min(datos$Fecha[!is.na(datos$Fallecimientos.dia)]),
                          max(datos$Fecha))) +
  labs(x = "", y = "Nº Fallecidos\n",
       title = "Fallecimientos diarios relacionados con COVID-19 en cada provincia",
       caption = "Nótese que, para facilitar la visualización de tendencias, la escala del eje vertical varía para cada provincia") +
  theme(axis.text.x = element_text(size = 8))
```

<br>


Realizado por [Francisco Rodríguez Sánchez](https://twitter.com/frod_san) a partir de los [datos]((https://www.juntadeandalucia.es/organismos/saludyfamilias/areas/salud-vida/paginas/Nuevo_Coronavirus.html)) ofrecidos por la Consejería de Salud y Familias de la Junta de Andalucía.


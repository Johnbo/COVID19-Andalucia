---
title: "Evolución de la enfermedad por coronavirus (COVID-19) en Andalucía"
output: 
  html_document: 
    fig_caption: yes
    fig_height: 5
    fig_width: 7
    theme: flatly
    toc: no
    self_contained: no
    includes: 
      in_header: header.html
---

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-46538450-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-46538450-3');
</script>



```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

# Garrick Adenbuie's gist to place TOC anywhere
# devtools::source_gist("c83e078bf8c81b035e32c3fc0cf04ee8", 
#                       filename = 'render_toc.R')
source("render_toc.R")
```

```{r pkgs, include=FALSE}
library(dplyr)
library(ggplot2)
#library(plotly)

mytheme <- theme_minimal(base_size = 12) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.caption = element_text(size = 8, face = "italic", colour = "grey60"),
        plot.subtitle = element_text(size = 9, face = "plain", colour = "grey50"),
        axis.ticks = element_line(colour = "grey80"),
        axis.ticks.length = unit(3, "pt"),
        strip.text = element_text(size = 12))
theme_set(mytheme)
```

<br>

Aquí se visualiza la evolución de la enfermedad COVID-19 causada por el coronavirus SARS-CoV2 en Andalucía, según los datos ofrecidos por la [Junta de Andalucía](http://www.juntadeandalucia.es/institutodeestadisticaycartografia/salud/COVID19.html), la [Fundación CIVIO](https://datos.civio.es/) y [Datadista](https://github.com/datadista/datasets/tree/master/COVID%2019). A diferencia de otras visualizaciones más extendidas, que representan datos acumulados en el tiempo, aquí se enfatizan las **variaciones diarias absolutas** (no acumuladas) en número de casos confirmados, personas ingresadas, curadas y fallecidas.

Los datos se **actualizan diariamente**. Tanto los datos como el código empleado para generar estas visualizaciones está disponible [aquí](https://github.com/Pakillo/COVID19-Andalucia).

Última actualización: `r Sys.Date()`

```{r render.toc}
render_toc("evolucion-coronavirus-andalucia.Rmd", base_level = 2, toc_depth = 1)
```




```{r datos}

library(readr)
library(assertr)

#datos <- readxl::read_excel("datos_brutos.xlsx", sheet = "datos")
# A partir del 20 de Abril, usando datos de la Junta
# http://www.juntadeandalucia.es/institutodeestadisticaycartografia/salud/COVID19.html

datos <- readr::read_csv2("datos/datos_provincias_raw.csv", 
                          col_types = "Dcci-",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = ".",
                                          date_format = "%d/%m/%Y"),
                          skip_empty_rows = TRUE) %>%
  filter(!is.na(Medida)) %>%
  mutate(Medida = ifelse(Medida == "Fallecidos", "Defunciones", Medida))

# datos %>%
#   assertr::verify(unique(.$Medida) == 
#                     c("Confirmados PCR", "Hospitalizados", "UCI", 
#                       "Curados", "Defunciones", "Total confirmados"))

datos <- datos %>%
  tidyr::pivot_wider(names_from = "Medida", values_from = "Valor") %>%
  rename(Fecha = `Fecha diagnóstico`, 
         ConfirmadosPCR = `Confirmados PCR`, 
         ConfirmadosTotal = `Total confirmados`) %>%
  dplyr::select(Fecha, Territorio, ConfirmadosPCR, ConfirmadosTotal, everything()) %>%
  arrange(Fecha) %>%
  dplyr::filter(Territorio != "España")


write_csv(datos, "datos/datos_provincias_clean.csv")

```


```{r datos.provs, include=FALSE}
datos.provs <- datos %>%
  filter(Territorio != "Andalucía", Territorio != "Provincia sin especificar")

datos.provs %>%
  verify(length(unique(Territorio)) == 8, success_fun = success_logical)

```


```{r datos.andal}

test.andal <- readxl::read_excel("datos/test_Andalucia.xlsx")
test.andal$Fecha <- as.Date(test.andal$Fecha)

datos.andal <- datos %>%
  filter(Territorio == "Andalucía") %>%
  left_join(test.andal[, c("Fecha", "Ntest.dia", "Confirmados.acum", "Prop.Positivos")], 
            by = "Fecha") %>%
  group_by(Fecha) %>%
  mutate(Prop.Positivos = 100 * Prop.Positivos) %>%
  ungroup()

```

<br>


## Resumen

<br>

```{r fig.resumen, out.width='100%', fig.height=6}

datos.andal.long <- datos.andal %>%
  select(Fecha:Defunciones, -ConfirmadosTotal) %>%
  tidyr::pivot_longer(cols = ConfirmadosPCR:Defunciones, names_to = "indic") %>%
  filter(indic != "Curados") %>%
  mutate(indic = ifelse(indic == "Hospitalizados", "Hospitalizaciones", indic)) %>%
  mutate(indic = ifelse(indic == "UCI", "Ingresos UCI", indic)) %>%
  mutate(indic = ifelse(indic == "ConfirmadosPCR", "Confirmados PCR", indic)) %>%
  mutate(indic = factor(indic, 
                        levels = c("Confirmados PCR", "Hospitalizaciones", 
                                   "Ingresos UCI", "Defunciones")))

ggplot(datos.andal.long) +
  facet_wrap(~indic, ncol = 1, scales = "free_y") + 
  geom_col(aes(x = Fecha, y = value, fill = indic)) +
  scale_fill_manual(values = c("#ff7f00", "#377eb8", "#e41a1c", "grey40")) +
  labs(x = "", y = "Nº personas", caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(legend.position = "none") +
  scale_x_date(limits = c(as.Date("2020-03-01"), NA)) +
  scale_y_continuous(sec.axis = dup_axis(name = ""))

```

<br>

Evolución en las **últimas dos semanas**:

```{r fig.resumen.14d, out.width='100%', fig.height=6}

datos.andal.long %>%
  filter(Fecha > as.Date(Sys.Date() - 16)) %>%
ggplot() +
  facet_wrap(~indic, ncol = 1, scales = "free_y") + 
  geom_col(aes(x = Fecha, y = value, fill = indic)) +
  scale_fill_manual(values = c("#ff7f00", "#377eb8", "#e41a1c", "grey40")) +
  labs(x = "", y = "Nº personas\n", caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(legend.position = "none") +
  scale_x_date(date_breaks = "2 days", date_labels = "%d %B") +
  scale_y_continuous(sec.axis = dup_axis(name = ""))

```



<br>

**DATOS DEL DÍA:** `r max(datos.andal$Fecha)`

```{r datos.last, out.width='100%'}

## Existen discordancias entre serie suministrada al ministerio y la depurada por la Junta a posteriori. Por tanto paso a usar la de la Junta siempre que se pueda

datos.minist <- read_csv2("datos/acumulados.csv", 
                        col_types = "Dcci-",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = ".",
                                          date_format = "%d/%m/%Y"),
                          skip_empty_rows = TRUE) %>%
  filter(Medida != "Confirmados PCR <14días", Medida != "Confirmados total") %>%
  mutate(Medida = ifelse(Medida == "Confirmados PCR", "ConfirmadosPCR", Medida),
         Medida = ifelse(Medida == "Total UCI", "UCI", Medida),
         Medida = ifelse(Medida == "Fallecimientos", "Defunciones", Medida),
         Medida = ifelse(Medida == "Curados", "Recuperados", Medida)) %>%
  tidyr::pivot_wider(names_from = "Medida", values_from = "Valor") %>%
  arrange(Fecha)

# datos.last <- datos.minist %>%
#   group_by(Territorio) %>%
#   mutate_at(3:8, function(x) {x - lag(x)}) %>%
#   filter(Fecha == max(Fecha)) %>%
#   ungroup()
#

## Usando la serie de la Junta (1 día de retraso)
datos.last <- datos.andal %>%
  dplyr::select(Fecha:Defunciones) %>%#
  bind_rows(datos.provs) %>%
  dplyr::select(-ConfirmadosTotal) %>%
  rename(Recuperados = Curados) %>%
  dplyr::select(-Recuperados, Recuperados) %>%
  filter(Fecha == max(Fecha)) %>%
  mutate_at(3:7, function(x) {ifelse(is.na(x), 0, x)})

kable(datos.last[, -1])

```


<br>

**DATOS ACUMULADOS:**

```{r datos.acum, out.width='100%'}
# Estos datos normalmente un día por delante de la serie de la Junta
datos.minist %>%
  filter(Fecha == max(Fecha)) %>%
  select(-Fecha) %>%
  kable()
```


<br>



## Casos confirmados

<br>

En primer lugar se muestra el número de casos confirmados diariamente mediante técnica PCR. 

<br>

```{r casos.pcr.datadista, fig.height=4, out.width='100%', eval=FALSE}

download.file("https://raw.githubusercontent.com/datadista/datasets/master/COVID%2019/ccaa_covid19_datos_isciii.csv", destfile = "datos/datadista_ccaa_covid19_datos_isciii.csv")

casos.pcr <- readr::read_csv("datos/datadista_ccaa_covid19_datos_isciii.csv", guess_max = 10000) %>%
  dplyr::filter(CCAA == "Andalucía") %>%
  rename(PCR = `PCR+`, TestAc = `TestAc+`) %>%
  mutate(Casos = ifelse(is.na(Casos), PCR + TestAc, Casos)) %>%
  mutate(PCR = ifelse(is.na(PCR), Casos, PCR)) %>% # assuming before 14 Abril all/most cases were PCR, no TestAc
  mutate(PCR.new = PCR - lag(PCR))
  

ggplot(casos.pcr) +
  geom_col(aes(x = Fecha, y = PCR.new), 
            fill = "#ff7f00") +
  scale_y_continuous(limits = c(0, NA), n.breaks = 6) +
  labs(x = "", y = "Nuevas detecciones\n",
       title = "Casos de COVID-19 confirmados diariamente por PCR en Andalucía",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(panel.grid.minor.y = element_line(size = rel(0.5)))

```



```{r casos.pcr, fig.height=4, out.width='100%'}

ggplot(datos.andal) +
  geom_col(aes(x = Fecha, y = ConfirmadosPCR), 
            fill = "#ff7f00") +
  scale_y_continuous(limits = c(0, NA), sec.axis = dup_axis(name = "")) +
  labs(x = "", y = "Nuevas detecciones\n",
       title = "Casos de COVID-19 confirmados diariamente por PCR en Andalucía",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(panel.grid.minor.y = element_line(size = rel(0.5))) +
  scale_x_date(limits = c(as.Date("2020-03-01"), NA))

```

<br>

Casos confirmados por PCR en los últimos 14 días:

<br>

```{r casos.pcr.14d, fig.height=4, out.width='100%'}

datos.andal %>%
  filter(Fecha > as.Date(Sys.Date() - 16)) %>%
ggplot() +
  geom_col(aes(x = Fecha, y = ConfirmadosPCR), 
            fill = "#ff7f00") +
  scale_y_continuous(limits = c(0, NA)) +
  labs(x = "", y = "Nuevas detecciones\n",
       title = "Casos de COVID-19 confirmados diariamente por PCR en Andalucía",
       subtitle = "Últimos 14 días",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(panel.grid.minor.y = element_line(size = rel(0.5))) +
  scale_x_date(date_breaks = "2 days", date_labels = "%d %B") +
  geom_text(aes(Fecha, y = ConfirmadosPCR + 30, label = ConfirmadosPCR),
            data = subset(datos.andal, Fecha > (Sys.Date() - 16))) 

```

<br>


```{r casos_Andalucia, fig.height=4, out.width='100%', eval = FALSE}

# Además de PCR, la Junta de Andalucía está realizando test rápidos, que sirven para detectar personas que han sido probablemente contagiadas por el virus (aunque actualmente puedan no mostrar síntomas o no tener carga viral significativa). Las gráficas de abajo incluyen tanto los casos detectados mediante PCR como mediante test serológicos (anticuerpos).
# 
# <br>


ggplot(datos.andal) +
  geom_col(aes(x = Fecha, y = ConfirmadosTotal), 
            fill = "#ff7f00") +
  geom_line(aes(x = Fecha, y = Ntest.dia), 
            size = 1, colour = "grey70") + 
  scale_y_continuous(limits = c(0, NA), n.breaks = 6) +
  labs(x = "", y = "Nuevas detecciones\n",
       title = "Casos de COVID-19 confirmados diariamente en Andalucía",
       subtitle = "La línea gris representa el número de test (PCR + serológicos) realizados diariamente",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(panel.grid.minor.y = element_line(size = rel(0.5)))

```


Debe tenerse en cuenta que el [número de casos confirmados depende en gran medida del número de test realizados](https://ourworldindata.org/covid-testing). Por tanto, un aumento o disminución en el número de casos confirmados puede deberse a haber realizado más o menos tests, no a variaciones en la incidencia de la enfermedad. Igualmente, durante los primeros meses de la pandemia (Marzo-Mayo 2020) solo se realizaron PCR para los pacientes más graves, dejando sin detectar probablemente [más del 90% de los casos](https://www.eldiario.es/sociedad/porcentaje-poblacion-contagiada-explosivo-COVID-19_0_1026798481.html), por lo que el número de casos diarios no es comparable entre periodos con distinta intensidad de muestreo. 

<br>



```{r ncasos.ntest, out.width='100%', fig.height=4, eval=FALSE}

## NB: algún día (ej. 4 Mayo hay más confirmados que test!)

ggplot(datos.andal) +
  geom_point(aes(Ntest.dia, ConfirmadosTotal), 
             size = 3, colour = "#ff7f00") +
  scale_y_continuous(limits = c(0, NA), 
                     name = "Número de casos confirmados\n") +
  scale_x_continuous(limits = c(0, NA),
                     name = "\nNúmero de test realizados") +
  labs(title = "Relación entre el número de casos confirmados\ny el número de test realizados diariamente",
       caption = "https://tiny.cc/COVID19-Andalucia")
```


```{r prop.positivos, fig.height=4, out.width = '100%', eval=FALSE}

# La proporción de casos positivos respecto al total de test realizados también [puede informarnos](https://www.theatlantic.com/technology/archive/2020/04/us-coronavirus-outbreak-out-control-test-positivity-rate/610132/) sobre la incidencia de la enfermedad. 
# 
# <br>
  
  
sec.axis.factor = 30

ggplot(datos.andal) +
  # geom_ribbon(aes(x = Fecha, ymin = prop.ci.low, ymax = prop.ci.up),
  #             fill = "#ff7f00", alpha = 0.3) +
  geom_col(aes(x = Fecha, y = Prop.Positivos), 
            fill = "#ff7f00") +
  geom_line(aes(x = Fecha, y = (Ntest.dia/sec.axis.factor)), 
            colour = "grey70", size = 1.5) +
  # geom_text(aes(x = Fecha, y = 5, label = Ntest.dia), 
  #           colour = "#ff7f00", alpha = 0.8) +
  scale_y_continuous(limits = c(0, 100), 
                     sec.axis = sec_axis(trans = ~ ((.*sec.axis.factor)), 
                                         breaks = seq(0, 3000, by = 500),
                                         name = "Número de test\n")) +
  scale_x_date(limits = c(as.Date("2020-03-26"), as.Date("2020-05-13"))) +
  labs(x = "", y = "Porcentaje de tests positivos\n",
       title = "Porcentaje de tests que dan positivo en Andalucía",
       subtitle = "La línea gris representa el número de test realizados diariamente (eje derecho)",
       caption = "https://tiny.cc/COVID19-Andalucia")


# (La Junta de Andalucía ha dejado de proporcionar datos diarios del número de personas testadas, por lo que esta gráfica ha dejado de actualizarse desde el 12 de Mayo)

```


<br>

A continuación se presentan los **casos confirmados mediante PCR en cada provincia**:

<br>

```{r casos_provincias, out.width = '100%', fig.height=6}

ggplot(datos.provs) +
  facet_wrap(~Territorio, scales = "free_y", ncol = 2) +
  geom_col(aes(x = Fecha, y = ConfirmadosPCR), 
            fill = "#ff7f00") +
  ylim(0, NA) +
  labs(x = "", y = "Nuevas detecciones\n",
       title = "Casos de COVID-19 confirmados por PCR en cada provincia",
       subtitle = "Para facilitar la visualización de tendencias la escala del eje vertical es diferente cada provincia",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(axis.text.x = element_text(size = 8)) +
  scale_x_date(limits = c(as.Date("2020-03-01"), NA))

```


<br>

Y en los últimos 14 días:

<br>

```{r casos_provincias.14d, out.width = '100%', fig.height=6}

datos.provs %>%
  filter(Fecha > as.Date(Sys.Date() - 16)) %>%
ggplot() +
  facet_wrap(~Territorio, ncol = 2) +
  geom_col(aes(x = Fecha, y = ConfirmadosPCR), 
            fill = "#ff7f00") +
  labs(x = "", y = "Nuevas detecciones\n",
       title = "Casos de COVID-19 confirmados por PCR en cada provincia",
       subtitle = "Últimos 14 días",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(axis.text.x = element_text(size = 8)) +
  scale_x_date(date_breaks = "4 days", date_labels = "%d %B") +
  scale_y_continuous(limits = c(0, NA), sec.axis = dup_axis(name = ""))

```

<br>

Pulse [aquí](#datos-por-municipio) para ver los **datos por municipio**. 

<br>


```{r distritos, eval=FALSE}
# 
# distritos.old <- gsheet::gsheet2tbl("https://docs.google.com/spreadsheets/d/1vH3y_4bL9n1sXOQjA91m8eqfbpCI-a8KV3cWXfQY3cI")
# 
# distritos <- distritos %>%
#   group_by(nombre) %>%
#   mutate(casos.dia = confirmados - lag(confirmados)) %>%
#   mutate(casos.dia = ifelse(fecha == as.Date("2020-04-11"), NA, casos.dia))

#stopifnot(distritos$casos.dia >=0)

```

```{r eval = FALSE}

distritos <- readxl::read_excel("datos/distritos_sanitarios.xlsx")

distri.data <- read_csv("datos/datos_distritos_confirmados.csv",
                        col_types = "Dccccci")

if (!fecha.distri %in% distri.data$Fecha) {
  
  distri.data.new <- readr::read_csv2("datos/datos_distritos_confirmados_dia.csv", 
                                      col_types = "cccci-",
                                      locale = locale(date_names = "es", 
                                                      decimal_mark = ",",
                                                      grouping_mark = ".",
                                                      date_format = "%d/%m/%Y"),
                                      skip_empty_rows = TRUE)
  
  distri.data.new <- distri.data.new %>%
    mutate(Fecha = fecha.distri) %>%
    rename(Casos = Valor) %>%
    dplyr::select(-Medida) %>%
    dplyr::select(Fecha, everything()) 
  
  
  # checks
  distri.data.new %>%
    verify(names(.) == c("Fecha", "Territorio", "Edad", "Sexo", "Casos")) %>%
    verify(sort(unique(.$Territorio)) == sort(distritos$Territorio)) %>%
    assert(within_bounds(0, Inf), Casos)
  
  # join
  distri.data.new <- distri.data.new %>%
    left_join(distritos, by = "Territorio") %>%
    dplyr::select(Fecha, Territorio, nombre.corto, provincia, everything()) %>%
    arrange(Fecha, provincia, Territorio)
  
  
  # add to former dataset
  distri.data <- bind_rows(distri.data, distri.data.new)
  
  # save
  write_csv(distri.data, "datos/datos_distritos_confirmados.csv")
  
}

```

```{r eval=FALSE}
# ## 23-04-2020: La Junta cambia nombre de distritos con nombre == a provincia
# distri.data <- distri.data %>%
#   mutate(Territorio = case_when(
#     Territorio == "Almería" ~ "Almería (distrito)",
#     Territorio == "Córdoba" ~ "Córdoba (distrito)",
#     Territorio == "Granada" ~ "Granada (distrito)",
#     Territorio == "Jaén" ~ "Jaén (distrito)",
#     Territorio == "Málaga" ~ "Málaga (distrito)",
#     Territorio == "Sevilla" ~ "Sevilla (distrito)",
#     TRUE ~ Territorio
#   ))

# distri.data <- distri.data %>%
#   mutate(nombre.corto = ifelse(nombre.corto == "Axarquia", "Axarquía", nombre.corto))

# distri.data <- distri.data %>%
#   filter(Fecha != "2020-04-22")
```

```{r casos.distri, out.width='100%', fig.height=7, eval=FALSE}

distri.data <- read_csv("datos/datos_distritos_confirmados.csv",
                        col_types = "Dccccci")

distri.data2plot <- distri.data %>%
  filter(Edad == "TOTAL", Sexo == "Ambos sexos") %>%
  filter(Fecha > as.Date("2020-04-10")) %>%
  group_by(Territorio) %>%
  mutate(Casos.new = Casos - lag(Casos)) %>%
  ungroup() %>%
  mutate(Casos.new = ifelse(Fecha == as.Date("2020-04-11"), NA, Casos.new))

distri.last <- dplyr::filter(distri.data2plot, Fecha == max(Fecha))

set.seed(5)

ggplot(distri.data2plot) +
  aes(x = Fecha, y = Casos.new) +
  facet_wrap(~provincia, ncol = 2) +
  geom_line(aes(group = nombre.corto, colour = nombre.corto), size = 1.5) +
  theme(legend.position = "none") +
  geom_point(data = distri.last, aes(colour = nombre.corto), size = 1.5) +
  scale_color_manual(values = sample(colorRampPalette(RColorBrewer::brewer.pal(n = 9, "Set1")[-6])(100))) +
  ggrepel::geom_text_repel(data = distri.last,
                           aes(label = nombre.corto, colour = nombre.corto), 
                           size = 2.5, nudge_x = 0.4, 
                           segment.size = 0.2, segment.alpha = 0.5) +
  scale_x_date(expand = expansion(mult = c(0, 0.5))) +
  labs(x = "", y = "Casos confirmados\n",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(strip.text = element_text(size = 12))

```


### Mapas


```{r mapa_distritos, out.width='100%', eval=FALSE}
casos.dist <- readxl::read_excel("datos/datos_brutos.xlsx", sheet = "distritos")

library(sf)

distritos <- st_read("Distritos/Distritos_2018.shp", 
                     stringsAsFactors = FALSE, quiet = TRUE) %>%
  mutate(CODIST = as.numeric(CODIST))

casos.dist <- left_join(select(distritos, CODIST, nombre),
                        select(casos.dist, CODIST, nombre, casos, fecha),
                        by = c("CODIST", "nombre"))


library(mapview)
mapviewOptions(legend.pos = "bottomleft")

mapview(casos.dist, zcol = "casos", 
        col.regions = colorRampPalette(RColorBrewer::brewer.pal(9, "YlOrRd")),
        alpha.regions = 0.9,
        map.types = "CartoDB.Positron",
        layer.name = "Casos",
        popup = leafpop::popupTable(casos.dist, 
                                    zcol = c("nombre", "casos", "fecha"), 
                           row.numbers = FALSE, feature.id = FALSE)) 

# ggplot(casos.dist) +
#   geom_sf(aes(fill = casos)) +
#   scale_fill_distiller(type = "seq", palette = "YlGnBu", direction = 1)
        
```

Este mapa de casos confirmados en los últimos 14 días es útil para saber dónde se encuentran los brotes activos en la actualidad:

```{r mapamunis_PCR_14d, out.width='100%'}

muni.data <- readr::read_csv("datos/municipios.csv", guess_max = 50000) %>%
  filter(Fecha == max(Fecha)) %>%
  rename(PROVINCIA = Provincia, MUNICIPIO = Municipio) %>%
  mutate(ConfirmadosPCR14d = ifelse(ConfirmadosPCR14d < 1, NA, ConfirmadosPCR14d))



library(sf)

# muni.gpkg <- st_read("datos/municipios.gpkg", 
#                      stringsAsFactors = FALSE, quiet = TRUE) 
# 
# muni.lite <- rmapshaper::ms_simplify(muni.gpkg, keep_shapes = TRUE, keep = 0.01)
# 
# st_write(muni.lite, "datos/municipios_lite.gpkg")

muni.lite <- st_read("datos/municipios_lite.gpkg", 
                     stringsAsFactors = FALSE, quiet = TRUE)

muni.14d <- left_join(select(muni.lite, PROVINCIA, MUNICIPIO),
                      select(muni.data, PROVINCIA, MUNICIPIO, ConfirmadosPCR14d),
                      by = c("PROVINCIA", "MUNICIPIO")) %>%
  mutate(casos = ifelse(is.na(ConfirmadosPCR14d), 0, ConfirmadosPCR14d),
         lab = paste(MUNICIPIO, casos, sep = ": "))

library(ggiraph)

mapa <- 
  ggplot(muni.14d) +
  ggiraph::geom_sf_interactive(aes(fill = ConfirmadosPCR14d, tooltip = lab), 
                               colour = "grey85", size = 0.1) +
  scale_fill_distiller(type = "seq", palette = "Oranges", direction = 1, 
                       na.value = "white") +
  #theme_minimal() +
  theme(axis.text = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "Casos confirmados por PCR en cada municipio",
       subtitle = "Últimos 14 días",
       caption = "https://tiny.cc/COVID19-Andalucia")

girafe(ggobj = mapa)

```

La Junta de Andalucía ha comenzado a visualizar los datos diarios por distrito sanitario y municipio [aquí](http://www.juntadeandalucia.es/institutodeestadisticaycartografia/salud/COVID19.html).

<br>




### Porcentaje de PCR positivas

Aquí se muestra el número de PCR realizadas en Andalucía cada semana (según los datos ofrecidos por [Datadista](https://github.com/datadista/datasets/tree/master/COVID%2019)), el número de casos detectados esa semana, y en consecuencia el porcentaje de PCR positivas. Si el porcentaje de pruebas positivas es elevado es probable que no se esten detectando todos los casos.


```{r test.posit, out.width='100%'}

ntest <- readr::read_csv2("https://raw.githubusercontent.com/datadista/datasets/master/COVID%2019/ccaa_covid19_test_realizados.csv") %>%
  filter(cod_ine == "01") %>%
  select(Fecha, cod_ine, CCAA, PCR)

# datos.andal$casos.7d <- zoo::rollsumr(datos.andal$ConfirmadosPCR, k = 7, fill = NA)

datos.andal <- datos.andal %>%
  mutate(casos.acum = cumsum(ConfirmadosPCR))

ntest <- datos.andal %>%
  select(Fecha, casos.acum) %>%
  right_join(ntest, by = "Fecha") %>%
  arrange(Fecha) %>%
  mutate(pcr.7d = PCR - lag(PCR),
         casos.7d = casos.acum - lag(casos.acum)) %>%
  mutate(pos.percent = 100*round(casos.7d/pcr.7d, digits = 3)) %>%
  select(Fecha, pcr.7d, casos.7d, pos.percent) %>%
  tidyr::pivot_longer(cols = pcr.7d:pos.percent) %>%
  mutate(name = case_when(
    name =="pcr.7d" ~ "PCR realizadas",
    name == "casos.7d" ~ "Casos confirmados",
    name == "pos.percent" ~ "Porcentaje de PCR positivas"
  )) %>%
  mutate(name = factor(name, levels = c("PCR realizadas", "Casos confirmados", "Porcentaje de PCR positivas"))) %>%
  filter(Fecha > "2020-04-23")

ggplot(ntest) + 
  facet_wrap(~name, ncol = 1, scales = "free_y") +
  geom_line(aes(Fecha, value, colour = name), size = 2) +
  ylim(0, NA) +
  scale_colour_manual(values = c("grey60", "#ff7f00", "black")) +
  theme(legend.position = "none") +
  labs(x = "", y = "",
       #title = "Porcentaje de personas con PCR positiva",
       caption = "https://tiny.cc/COVID19-Andalucia")
  

```


<br>



### Casos confirmados por fecha y rango de edad

Esta figura representa los rangos de edad de los casos confirmados por PCR a lo largo del tiempo (desde el 15 de Marzo de 2020). 

Mientras que en los meses de Marzo a Mayo la inmensa mayoría de casos detectados tenían más de 30 años, en las últimas semanas la mayoría de casos corresponde a personas más jóvenes (15 a 65 años), aunque paulatinamente los contagios se extienden a todas las edades.

<br>


```{r casos.edad.fecha, out.width='100%', fig.height=2.5}

library(stringr)

casos.edad.fecha <- read_csv2("datos/confPCR_edad_fecha.csv",
                          skip_empty_rows = TRUE) %>%
  select(-Medida, - X5) %>%
  filter(!is.na(Edad)) %>%
  tidyr::separate(col = "Fecha diagnóstico", into = c("Dia", "Mes"), sep = "/", remove = TRUE) %>%
  mutate(Fecha = paste("2020", Mes, Dia, sep = "-")) %>%
  mutate(Fecha = as.Date(Fecha)) %>%
  mutate(edades = str_replace(Edad, "De ", "")) %>%
  mutate(edades = str_replace(edades, " a ", " - ")) %>%
  mutate(edades = str_replace(edades, " años", "")) %>%
  mutate(edades = factor(edades,
                         levels = rev(c("0 - 14", "15 - 29", "30 - 44", "45 - 64", "65 - 84", "85 y más")))) %>%
  rename(Casos = Valor) %>%
  mutate(Casos = ifelse(is.na(Casos), 0, Casos))

casos.edad.fecha %>%
  filter(Fecha > "2020-03-14") %>%
  ggplot() +
  geom_tile(aes(x = Fecha, y = edades, fill = Casos)) +
  scale_fill_viridis_c() +
  labs(y = "Edad", x = "",
       title = "Edad de los casos confirmados por PCR",
       caption = "https://tiny.cc/COVID19-Andalucia") 

```

<br>


```{r casos.edad.anim, out.width='100%', eval = FALSE}

library(gganimate)

edad.anim <- 
  casos.edad.fecha %>%
  mutate(edades = factor(edades,
                         levels = (c("0 - 14", "15 - 29", "30 - 44", "45 - 64", "65 - 84", "85 y más")))) %>%
  filter(Fecha > "2020-07-01") %>%
  ggplot() +
  geom_col(aes(edades, Casos), fill = "#ff7f00") +
  transition_states(Fecha, wrap = FALSE) +
  labs(y = "Número de casos diarios\n", x = "Edad",
       title = "Edad de los casos confirmados por PCR",
       subtitle = "{closest_state}",
       caption = "https://tiny.cc/COVID19-Andalucia") 

animate(edad.anim, height = 5, width = 7, units = "in", res = 150, duration = 15, rewind = FALSE)
anim_save("edad_casos_anim.gif")

    
```



## Ingresos en centros hospitalarios

<br>


```{r ingresos_Andalucia, fig.height=3, out.width='100%'}

ggplot(datos.andal) +
  geom_col(aes(x = Fecha, y = Hospitalizados), 
            fill = "#377eb8") +
  ylim(0, NA) +
  labs(x = "", y = "Nº Ingresos\n",
       title = "Hospitalizaciones diarias con COVID-19 en Andalucía",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_x_date(limits = c(as.Date("2020-03-01"), NA))

```


<br>


```{r ingresos_Andalucia.14d, fig.height=3, out.width='100%'}

ggplot(datos.andal) +
  geom_col(aes(x = Fecha, y = Hospitalizados), 
            fill = "#377eb8") +
  ylim(0, NA) +
  labs(x = "", y = "Nº Ingresos\n",
       title = "Hospitalizaciones diarias con COVID-19 en Andalucía",
       subtitle = "Últimos 14 días",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_x_date(limits = c(Sys.Date() - 16, NA), 
               date_breaks = "2 days", date_labels = "%d %B") +
  geom_text(aes(Fecha, y = Hospitalizados + 4, label = Hospitalizados),
            data = subset(datos.andal, Fecha > (Sys.Date() - 16))) 
  

```

<br>
<br>


```{r ingresos_provincias, out.width='100%', fig.height=6}

ggplot(datos.provs) +
  facet_wrap(~Territorio, scales = "free_y", ncol = 2) +
  geom_col(aes(x = Fecha, y = Hospitalizados), 
            fill = "#377eb8") +
  ylim(0, NA) +
  labs(x = "", y = "Nº Ingresos\n",
       title = "Hospitalizaciones diarias con COVID-19 en cada provincia",
       subtitle = "Para facilitar la visualización de tendencias la escala del eje vertical es diferente en cada provincia",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(axis.text.x = element_text(size = 8)) +
  scale_x_date(limits = c(as.Date("2020-03-01"), NA))

```


<br>


```{r ingresos_provincias.14d, out.width='100%', fig.height=6}

ggplot(datos.provs) +
  facet_wrap(~Territorio, ncol = 2) +
  geom_col(aes(x = Fecha, y = Hospitalizados), 
            fill = "#377eb8") +
  labs(x = "", y = "Nº Ingresos\n",
       title = "Hospitalizaciones diarias con COVID-19 en cada provincia",
       subtitle = "Últimos 14 días",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(axis.text.x = element_text(size = 8)) +
  scale_x_date(limits = c(Sys.Date() - 16, NA), 
               date_breaks = "4 days", date_labels = "%d %B") +
  scale_y_continuous(limits = c(0, NA), sec.axis = dup_axis(name = ""))

```

<br>


### Ingresos en cuidados intensivos (UCI)

<br>


```{r uci_Andalucia, fig.height=3, out.width='100%'}

ggplot(datos.andal) +
  geom_col(aes(x = Fecha, y = UCI), fill = "#e41a1c") +
  ylim(0, NA) +
  labs(x = "", y = "Nº Ingresos UCI\n",
       title = "Ingresos diarios en UCI con COVID-19 en Andalucía",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_x_date(limits = c(as.Date("2020-03-01"), NA))

```


<br>


```{r uci_Andalucia.14d, fig.height=3, out.width='100%'}

ggplot(datos.andal) +
  geom_col(aes(x = Fecha, y = UCI), fill = "#e41a1c") +
  ylim(0, NA) +
  labs(x = "", y = "Nº Ingresos UCI\n",
       title = "Ingresos diarios en UCI con COVID-19 en Andalucía",
       subtitle = "Últimos 14 días",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_x_date(limits = c(Sys.Date() - 16, NA), 
               date_breaks = "2 days", date_labels = "%d %B") 

```
<br>
<br>


```{r uci_provincias, out.width='100%', eval=FALSE}

ggplot(datos.provs) +
  facet_wrap(~Territorio, scales = "free_y", ncol = 2) +
  geom_col(aes(x = Fecha, y = UCI), fill = "#e41a1c") +
  ylim(0, NA) +
  labs(x = "", y = "Nº Ingresos UCI\n",
       title = "Ingresos diarios en UCI en cada provincia",
       subtitle = "Para facilitar la visualización de tendencias, la escala del eje vertical es diferente cada provincia",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(axis.text.x = element_text(size = 8))

```


### Camas ocupadas

<br>

Número de camas ocupadas en centros hospitalarios, y cuántas de ellas son de cuidados intensivos (UCI):

<br>

```{r camas.ocupadas, out.width='100%', fig.height=3}

camas <- readxl::read_excel("datos/camas_ocupadas.xlsx") %>%
  mutate(Fecha = as.Date(Fecha)) %>%
  filter(Territorio == "Andalucía") 
camas.last <- camas %>%
  filter(!is.na(CamasOcup)) %>%
  slice_tail()

ggplot(camas) +
  geom_line(aes(Fecha, CamasOcup), colour = "#377eb8", size = 2) +
  geom_line(aes(Fecha, UCI), colour = "#e41a1c", size = 2) +
  ylim(0, NA) +
  labs(title = "Camas ocupadas con COVID-19 en hospitales andaluces",
       caption = "https://tiny.cc/COVID19-Andalucia",
       x = "", y = "Camas ocupadas\n") +
  geom_text(data = camas.last, 
            aes(Fecha - 2, CamasOcup + 40, label = paste0( "Total ", CamasOcup)),
            colour = "#377eb8") +
  geom_text(data = camas.last, 
            aes(Fecha - 2, UCI + 40, label = paste0("UCI ", UCI)), 
            colour = "#e41a1c") 
  

```


<br>


## Personas curadas

<br>


```{r curadas_Andalucia, fig.height=3, out.width='100%'}

ggplot(datos.andal) +
  geom_col(aes(x = Fecha, y = Curados), 
            size = 1.5, fill = "#4daf4a") +
  ylim(0, NA) +
  #scale_x_date(limits = c(as.Date("2020-03-23"), NA)) +
  labs(x = "", y = "Nº Personas\n",
       title = "Personas curadas de COVID-19 diariamente en Andalucía",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_x_date(limits = c(as.Date("2020-03-01"), NA))

```


<br>
<br>


```{r curadas_provincias, out.width='100%', eval=FALSE}

ggplot(datos.provs) +
  facet_wrap(~Territorio, scales = "free_y", ncol = 2) +
  geom_col(aes(x = Fecha, y = Curados), 
            size = 1.5, fill = "#4daf4a") +
  ylim(0, NA) +
  labs(x = "", y = "Nº Personas\n",
       title = "Personas curadas diariamente en cada provincia",
       caption = "Nótese que, para facilitar la visualización de tendencias, la escala del eje vertical varía para cada provincia") +
  theme(axis.text.x = element_text(size = 8))

```


<br>



## Defunciones

<br>

```{r fallecidos_Andalucia, fig.height=3, out.width='100%'}

ggplot(datos.andal) +
  geom_col(aes(x = Fecha, y = Defunciones), fill = "grey40") +
  labs(x = "", y = "Nº Defunciones\n",
       title = "Defunciones diarias relacionadas con COVID-19 en Andalucía",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_y_continuous(limits = c(0, NA)) +
  scale_x_date(limits = c(as.Date("2020-03-01"), NA))

```

<br>

```{r fallecidos_Andalucia.14d, fig.height=3, out.width='100%'}

ggplot(datos.andal) +
  geom_col(aes(x = Fecha, y = Defunciones), fill = "grey40") +
  labs(x = "", y = "Nº Defunciones\n",
       title = "Defunciones diarias relacionadas con COVID-19 en Andalucía",
       subtitle = "Últimos 14 días",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_y_continuous(limits = c(0, NA)) +
  scale_x_date(limits = c(Sys.Date() - 16, NA), 
               date_breaks = "2 days", date_labels = "%d %B") 

```

<br>
<br>

```{r fallecidos_provincias, eval = TRUE, out.width='100%', fig.height=6}
         
ggplot(datos.provs) +
  facet_wrap(~Territorio, ncol = 2) +  
  geom_col(aes(x = Fecha, y = Defunciones), 
            size = 1.5, fill = "grey40") +
  scale_y_continuous(limits = c(0, NA)) +
  #scale_x_date(limits = c(as.Date("2020-03-10"), NA)) +
  labs(x = "", y = "Nº Defunciones\n",
       title = "Defunciones diarias relacionadas con COVID-19 en cada provincia",
       subtitle = "Para facilitar la visualización de tendencias, la escala del eje vertical es diferente en cada provincia",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(axis.text.x = element_text(size = 8)) +
  scale_x_date(limits = c(as.Date("2020-03-01"), NA))

```

<br>





## Datos por municipio



<br>

```{r tabla.muni, out.width='100%', eval=FALSE}
# Esta tabla contiene los datos de casos confirmados y defunciones acumuladas por municipio. Se pueden realizar búsquedas en toda la tabla o filtrar valores en cada columna.

library(DT)

muni.data <- readr::read_csv("datos/municipios.csv", guess_max = 10000)
#muni.data$Provincia <- as.factor(muni.data$Provincia)

datatable(muni.data, rownames = FALSE, filter = "top")
```


Seleccione provincia y municipio para visualizar el número de casos confirmados y defunciones por municipio.

<br>

```{r shiny.muni, out.width='100%'}
include_app("https://frodsan.shinyapps.io/COVID19-Municipios-Andalucia/", 
            height = '600px')
```


<br>



## Distribucion por edad y sexo

<br>

```{r dist.edad.sexo, out.width='100%', fig.height=4}

casos.edad.sexo <- read_csv2("datos/edad.sexo/datos_casos_edad_sexo.csv",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = "."),
                          skip_empty_rows = TRUE) %>%
  select(-X5) %>%
  filter(Medida == "% pirámide") %>%
  mutate(Medida = "% Casos") %>%
  filter(!is.na(Edad))


hosp.edad.sexo <- read_csv2("datos/edad.sexo/datos_hosp_edad_sexo.csv",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = "."),
                          skip_empty_rows = TRUE) %>%
  select(-X5) %>%
  filter(Medida == "% pirámide") %>%
  mutate(Medida = "% Hospitalizaciones") %>%
  filter(!is.na(Edad))


uci.edad.sexo <- read_csv2("datos/edad.sexo/datos_uci_edad_sexo.csv",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = "."),
                          skip_empty_rows = TRUE) %>%
  select(-X5) %>%
  filter(Medida == "% pirámide") %>%
  mutate(Medida = "% UCI") %>%
  filter(!is.na(Edad))


def.edad.sexo <- read_csv2("datos/edad.sexo/datos_def_edad_sexo.csv",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = "."),
                          skip_empty_rows = TRUE) %>%
  select(-X5) %>%
  filter(Medida == "% pirámide") %>%
  mutate(Medida = "% Defunciones") %>%
  filter(!is.na(Edad)) %>%
  right_join(casos.edad.sexo[, c("Edad", "Sexo")], by = c("Edad", "Sexo")) %>%
  mutate(Medida = "% Defunciones")


recup.edad.sexo <- read_csv2("datos/edad.sexo/datos_curados_edad_sexo.csv",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = "."),
                          skip_empty_rows = TRUE) %>%
  select(-X5) %>%
  filter(Medida == "% pirámide") %>%
  mutate(Medida = "% Recuperados") %>%
  filter(!is.na(Edad))


## Obtener etiquetas edades
library(stringr)
edades <- casos.edad.sexo %>%
  filter(Sexo == "Hombres") %>%
  mutate(edades = str_replace(Edad, "De ", "")) %>%
  mutate(edades = str_replace(edades, " a ", " - ")) %>%
  mutate(edades = str_replace(edades, " años", "")) %>%
  pull(edades)
  #mutate(edades = rev(edades))


## Juntar todas las variables

todo.edad.sexo <- bind_rows(casos.edad.sexo, 
                            hosp.edad.sexo,
                            uci.edad.sexo,
                            def.edad.sexo,
                            recup.edad.sexo) %>%
  group_by(Sexo, Medida) %>%
  mutate(edades = factor(edades, levels = edades)) %>%
  ungroup() %>%
  mutate(Medida = factor(Medida, levels = c("% Casos", "% Recuperados",
                                            "% Hospitalizaciones", "% UCI", "% Defunciones")))


## Fig hombres
todo.edad.sexo %>%
  filter(Sexo == "Hombres") %>%
ggplot() +
  facet_wrap(~Medida, nrow = 1) + 
  coord_flip() +
  geom_col(aes(x = edades, y = Valor), fill = "#ff7f00") +
  labs(x = "Edad (años)", y = "Porcentaje (%)", title = "Hombres",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(title = element_text(size = 15),
        axis.text.y = element_text(size = 8),
        strip.text = element_text(size = 9),
        axis.title = element_text(size = 10))


## Fig mujeres
todo.edad.sexo %>%
  filter(Sexo == "Mujeres") %>%
ggplot() +
  facet_wrap(~Medida, nrow = 1) + 
  coord_flip() +
  geom_col(aes(x = edades, y = Valor), fill = "#984ea3") +
  labs(x = "Edad (años)", y = "Porcentaje (%)", title = "Mujeres",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(title = element_text(size = 15),
        axis.text.y = element_text(size = 8),
        strip.text = element_text(size = 9),
        axis.title = element_text(size = 10)) +
  scale_y_continuous(breaks = seq(0, 10, 2))

```



<br>



## Letalidad

<br>

Aquí se representa, para cada sexo y franja de edad, la proporción de casos confirmados de COVID-19 que acaban en defunción (lo que en inglés se conoce como [Case Fatality Rate](https://en.wikipedia.org/wiki/Case_fatality_rate)). Estos valores sirven para tener una idea aproximada de la letalidad del virus, aunque la probabilidad individual de defunción depende de muchos otros factores (otras enfermedades, mejoras en los tratamientos, etc). Los valores que aquí se presentan además no tienen en cuenta las defunciones que pueden ocurrir en las próximas semanas de personas ahora infectadas. Ni las defunciones debidas a COVID-19 pero no diagnosticadas.

En cualquier caso, es evidente que la letalidad aumenta con la edad y es mayor en hombres que en mujeres. 

<br>

```{r letalidad, out.width='100%', fig.height=5}

casos.edad.sexo <- read_csv2("datos/edad.sexo/datos_casos_edad_sexo.csv",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = "."),
                          skip_empty_rows = TRUE) %>%
  select(-X5) %>%
  filter(Medida == "Confirmado PCR") %>%
  filter(!is.na(Edad)) %>%
  rename(Casos = Valor) %>%
  select(-Medida)

def.edad.sexo <- read_csv2("datos/edad.sexo/datos_def_edad_sexo.csv",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = "."),
                          skip_empty_rows = TRUE) %>%
  select(-X5) %>%
  filter(Medida == "Fallecidos") %>%
  filter(!is.na(Edad))  %>%
  rename(Fallecidos = Valor) %>%
  select(-Medida)


cfr <- left_join(casos.edad.sexo, def.edad.sexo, by = c("Edad", "Sexo")) %>%
  mutate(Fallecidos = ifelse(is.na(Fallecidos), 0, Fallecidos)) %>%
  mutate(CFR = 100*Fallecidos/Casos) %>%
  filter(Edad != "De 100 y más años") %>%
  mutate(edades = factor(rep(edades[-1], each = 2), levels = edades[-1]))


ggplot(cfr) +
  facet_wrap(~Sexo, ncol = 2, scales = "free_x") +
  geom_col(aes(edades, CFR, fill = Sexo)) +
  coord_flip() +
  labs(y = "Porcentaje de casos que acaban en defunción (%)", x = "Edad\n", 
       title = "Letalidad por COVID-19 en Andalucía",
       subtitle = "Proporción de muertes respecto al número de casos confirmados\nen cada categoría de edad y sexo",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_fill_manual(values = c("#ff7f00", "#984ea3")) +
  theme(legend.position = "none")

```

<br>

## Comparacion con otras CCAA

<br>

Andalucía es de las comunidades autónomas que [menos test ha realizado](https://elpais.com/sociedad/2020-04-27/la-rioja-hace-siete-veces-mas-pruebas-pcr-por-habitante-que-andalucia.html) en relación al tamaño de su población (al menos hasta mediados de Abril). Por tanto el número de casos de COVID-19 puede estar notablemente infraestimado. De hecho, los primeros resultados del estudio serológico indican que [en Andalucía se han detectado probablemente menos del 10% de los contagios](https://www.eldiario.es/sociedad/porcentaje-poblacion-contagiada-explosivo-COVID-19_0_1026798481.html). En general, no debemos comparar el número de casos entre comunidades sin tener en cuenta la enorme variación en el número de test realizados.

<br>

```{r test.ccaa, out.width='100%'}
test.ccaa <- readxl::read_excel("datos/ntest_casos_ccaa_14Apr.xlsx")

set.seed(123)
ggplot(test.ccaa) +
  geom_point(aes(Ntest.pop, Casos.pop), size = 2) +
  ggrepel::geom_text_repel(aes(x = Ntest.pop, y = Casos.pop, label = CCAA),
                           size = 3, nudge_x = 10, nudge_y = 30) +
  scale_x_continuous(name = "\nNúmero de test por 100.000 habitantes",
                     limits = c(0, NA)) +
  scale_y_continuous(name = "Número de casos por 100.000 habitantes\n",
                     limits = c(0, NA)) +
  labs(title = "Número de casos detectados en relación al número de test\nrealizados por CC.AA.",
       caption = "Datos a 14 de Abril (Fuente: https://datos.civio.es)\nhttps://tiny.cc/COVID19-Andalucia") 
```

<br>
<br>


```{r confirmados.ccaa, fig.height=5, out.width='100%'}

ccaa.pcr <- readr::read_csv("https://raw.githubusercontent.com/datadista/datasets/master/COVID%2019/ccaa_covid19_datos_isciii_nueva_serie.csv", guess_max = 10000) 

library(plotly)

options(scipen = 1000)

ggplotly(
  ggplot(ccaa.pcr) +
  geom_line(aes(x = fecha, y = num_casos_prueba_pcr, group = ccaa), 
              colour = "grey80") +
  geom_line(aes(x = fecha, y = num_casos_prueba_pcr), 
            data = subset(ccaa.pcr, ccaa == "Andalucía"), 
            colour = "#ff7f00", size = 2) +
  #scale_y_log10() +
  labs(x = "", y = "Confirmados PCR\n",
       title = "Casos de COVID-19 confirmados por PCR en cada CCAA",
       #subtitle = "Escala logarítmica",
       caption = "https://tiny.cc/COVID19-Andalucia")
)

```




<br>

Realizado por [Francisco Rodríguez Sánchez](https://twitter.com/frod_san) a partir de los [datos](https://github.com/Pakillo/COVID19-Andalucia/tree/master/datos) ofrecidos por la Consejería de Salud y Familias de la Junta de Andalucía, la Fundación CIVIO y Datadista. Reproducción permitida con fines no comerciales citando la fuente (CC-BY-NC 4.0).



---
title: "Evolución de la enfermedad por coronavirus (COVID-19) en Andalucía"
output: 
  html_document: 
    fig_caption: yes
    fig_height: 5
    fig_width: 7
    theme: flatly
    toc: no
    self_contained: no
    includes: 
      in_header: header.html
---

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-46538450-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-46538450-3');
</script>



```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, out.width = "100%")

# Garrick Adenbuie's gist to place TOC anywhere
# devtools::source_gist("c83e078bf8c81b035e32c3fc0cf04ee8", 
#                       filename = 'render_toc.R')
source("render_toc.R")
```

```{r pkgs, include=FALSE}
library(dplyr)
library(ggplot2)
#library(plotly)

mytheme <- theme_minimal(base_size = 12) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.caption = element_text(size = 8, face = "italic", colour = "grey60"),
        plot.subtitle = element_text(size = 9, face = "plain", colour = "grey50"),
        axis.ticks = element_line(colour = "grey80"),
        axis.ticks.length = unit(3, "pt"),
        strip.text = element_text(size = 12))
theme_set(mytheme)
```

<br>

Aquí se visualiza la evolución de la enfermedad COVID-19 causada por el coronavirus SARS-CoV2 en Andalucía, según los datos ofrecidos por la [Junta de Andalucía](http://www.juntadeandalucia.es/institutodeestadisticaycartografia/salud/COVID19.html), el [Ministerio de Sanidad](https://www.mscbs.gob.es/profesionales/saludPublica/ccayes/alertasActual/nCov/situacionActual.htm?q=service/), la [Fundación CIVIO](https://datos.civio.es/) y [Datadista](https://github.com/datadista/datasets/tree/master/COVID%2019). A diferencia de otras visualizaciones más extendidas, que representan datos acumulados en el tiempo, aquí se enfatizan las **variaciones diarias absolutas** (no acumuladas).

Los datos se **actualizan diariamente**. En esta [cuenta de twitter](https://twitter.com/covid_andalucia) compartiremos la información más relevante. Tanto los datos como el código empleado para generar estas visualizaciones está disponible [aquí](https://github.com/Pakillo/COVID19-Andalucia). 

Última actualización: `r Sys.Date()`

```{r render.toc}
render_toc("evolucion-coronavirus-andalucia.Rmd", base_level = 2, toc_depth = 1)
```




```{r datos}

library(readr)
library(assertr)

#datos <- readxl::read_excel("datos_brutos.xlsx", sheet = "datos")
# A partir del 20 de Abril, usando datos de la Junta
# http://www.juntadeandalucia.es/institutodeestadisticaycartografia/salud/COVID19.html

datos <- readr::read_csv2("datos/datos_provincias_raw.csv", 
                          col_types = "Dcci-",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = ".",
                                          date_format = "%d/%m/%Y"),
                          skip_empty_rows = TRUE) %>%
  filter(!is.na(Medida)) %>%
  mutate(Medida = ifelse(Medida == "Fallecidos", "Defunciones", Medida))

# datos %>%
#   assertr::verify(unique(.$Medida) == 
#                     c("Confirmados PCR", "Hospitalizados", "UCI", 
#                       "Curados", "Defunciones", "Total confirmados"))

datos <- datos %>%
  tidyr::pivot_wider(names_from = "Medida", values_from = "Valor") %>%
  rename(Fecha = `Fecha diagnóstico`, 
         ConfirmadosPCR = `Confirmados PDIA`, 
         ConfirmadosTotal = `Total confirmados`) %>%
  dplyr::select(Fecha, Territorio, ConfirmadosPCR, ConfirmadosTotal, everything()) %>%
  arrange(Fecha) %>%
  dplyr::filter(Territorio != "España")


write_csv(datos, "datos/datos_provincias_clean.csv")

```


```{r datos.provs, include=FALSE}
datos.provs <- datos %>%
  filter(Territorio != "Andalucía", Territorio != "Provincia sin especificar")

datos.provs %>%
  verify(length(unique(Territorio)) == 8, success_fun = success_logical)

```


```{r datos.andal}

## Datos test de Junta Andalucía
# test.andal <- readxl::read_excel("datos/test_Andalucia.xlsx")
# test.andal$Fecha <- as.Date(test.andal$Fecha)

datos.andal <- datos %>%
  filter(Territorio == "Andalucía") 
  # left_join(test.minist, by = "Fecha") 
  
```

```{r casos.edad.fecha}

library(stringr)

casos.edad.fecha <- read_csv2("datos/confPCR_edad_fecha.csv",
                          skip_empty_rows = TRUE) %>%
  select(-Medida, - X5) %>%
  filter(!is.na(Edad)) %>%
  tidyr::separate(col = "Fecha diagnóstico", into = c("Dia", "Mes"), sep = "/", remove = TRUE) %>%
  mutate(Fecha = paste("2020", Mes, Dia, sep = "-")) %>%
  mutate(Fecha = as.Date(Fecha)) %>%
  mutate(edades = str_replace(Edad, "De ", "")) %>%
  mutate(edades = str_replace(edades, " a ", " - ")) %>%
  mutate(edades = str_replace(edades, " años", "")) %>%
  mutate(edades = factor(edades,
                         levels = rev(c("0 - 14", "15 - 29", "30 - 44", "45 - 64", "65 - 84", "85 y más")))) %>%
  rename(Casos = Valor) %>%
  mutate(Casos = ifelse(is.na(Casos), 0, Casos)) %>% 
  select(-Dia, -Mes) %>% 
  select(Fecha, everything()) 

## Nº de habitantes en cada categoria
# Datos de 2019 (https://www.juntadeandalucia.es/institutodeestadisticaycartografia/badea/operaciones/consulta/anual/21974?CodOper=b3_151&codConsulta=21974) 
nhab.edad.sexo <- data.frame(
  Edad = sort(unique(casos.edad.fecha$Edad)),
  nhab = c(
    1322951, #0-14
    1380773, #15-29
    1869844, #30-44
    2400570, #45-64
    1236622, #65-84 (estimado as Casos*100000 / Tasa)
    203606 #85+ (estimado as Casos*100000 / Tasa)
  )
)


casos.edad.fecha <- casos.edad.fecha %>% 
  left_join(nhab.edad.sexo, by = "Edad") %>% 
  group_by(Edad) %>% 
  mutate(Casos.acum = cumsum(Casos)) %>% 
  mutate(Casos.14d = Casos.acum - lag(Casos.acum, n = 14)) %>% 
  mutate(IA.14d = Casos.14d*100000 / nhab) %>% 
  ungroup()

## incidencia acumulada >65 años

# Nº personas >=65 años: 1440102
# Datos de 2019 (https://www.juntadeandalucia.es/institutodeestadisticaycartografia/badea/operaciones/consulta/anual/21974?CodOper=b3_151&codConsulta=21974)

casos.65 <- casos.edad.fecha %>% 
  filter(Edad == "De 65 a 84 años" | Edad == "De 85 y más años") %>% 
  group_by(Fecha) %>% 
  summarise(Casos = sum(Casos)) %>% 
  mutate(Casos.acum = cumsum(Casos)) %>% 
  mutate(Casos.14d = Casos.acum - lag(Casos.acum, n = 14),
         Casos.7d = Casos.acum - lag(Casos.acum, n = 7)) %>% 
  mutate(Tasa.14d.65a = Casos.14d * 100000 / 1440102,
         Tasa.7d.65a = Casos.7d * 100000 / 1440102) %>% 
  mutate(Territorio = "Andalucía") 
  
  
```


```{r datos.minist}

datos.minist <- read_csv2("datos/acumulados.csv", 
                        col_types = "Dcci-",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = ".",
                                          date_format = "%d/%m/%Y"),
                          skip_empty_rows = TRUE) %>%
  filter(Medida != "Total confirmados") %>%
  mutate(Medida = stringr::str_replace_all(Medida, " PDIA", "")) %>% 
  mutate(Medida = stringr::str_replace_all(Medida, " días", "d")) %>% 
  mutate(Medida = ifelse(Medida == "Confirmados PCR", "ConfirmadosPCR", Medida),
         Medida = ifelse(Medida == "Total UCI", "UCI", Medida),
         Medida = ifelse(Medida == "Fallecidos", "Defunciones", Medida),
         Medida = ifelse(Medida == "Curados", "Recuperados", Medida)) %>%
  tidyr::pivot_wider(names_from = "Medida", values_from = "Valor") %>%
  arrange(Fecha) %>% 
  mutate(Tasa.14d = `Confirmados 14d` *100000 / 8414240,  # Poblacion Andalucia = 8414240
         Tasa.7d = `Confirmados 7d` *100000 / 8414240)


## Add tasas mayores de 65 años
datos.minist <- datos.minist %>% 
  left_join(casos.65, by = c("Fecha", "Territorio"))

## Add datos positividad + trazabilidad
test.minist <- readxl::read_excel("datos/positividad_Ministerio.xlsx")
test.minist$Fecha <- as.Date(test.minist$Fecha)

datos.minist <- datos.minist %>% 
  full_join(test.minist, by = c("Fecha", "Territorio"))


# Add datos camas ocupadas
camas <- readxl::read_excel("datos/camas_ocupadas.xlsx") %>%
  mutate(Fecha = as.Date(Fecha)) %>%
  rename(CamasUCI = UCI)

datos.minist <- datos.minist %>%
  left_join(camas, by = c("Fecha", "Territorio")) %>% 
  arrange(Fecha)

datos.minist.andal <- datos.minist %>% 
  filter(Territorio == "Andalucía")

```



<br>


## Indicadores Ministerio Sanidad (semáforo)

Las siguientes gráficas muestran la evolución de cada uno de los [indicadores](https://www.lamoncloa.gob.es/serviciosdeprensa/notasprensa/sanidad14/Documents/2020/221020_ActuacionesrespuestaCOVID.pdf) aprobados por el Consejo Interterritorial de Salud.

Los distintos colores representan [niveles crecientes de riesgo](https://twitter.com/DadosdeLaplace/status/1319326140671066113/photo/1), desde el verde ("nueva normalidad") al morado ("riesgo extremo").

<br>

### Bloque 1: Nivel de Transmisión

<br>

```{r IA14, fig.height=4}

datos.plot <- datos.minist.andal %>% 
  filter(!is.na(Tasa.14d)) 

ggplot(datos.plot) +
  geom_line(aes(Fecha, Tasa.14d), size = 2) +
  annotate("text", x = 4 + max(datos.plot$Fecha), 
           y = datos.plot$Tasa.14d[nrow(datos.plot)],
           label = round(datos.plot$Tasa.14d[nrow(datos.plot)])) +
  geom_ribbon(aes(x = Fecha, ymin = 0, ymax = 25), fill = "#4daf4a", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 25, ymax = 50), fill = "#ffff33", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 50, ymax = 150), fill = "#ff7f00", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 150, ymax = 250), fill = "#e41a1c", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 250, ymax = max(Tasa.14d)), 
              fill = "#984ea3", alpha = 0.3) +
  labs(x = "", y = "",
       title = "Incidencia Acumulada 14 días",
       subtitle = "Casos confirmados en los últimos 14 días por cada 100.000 habitantes",
       caption = "https://tiny.cc/COVID19-Andalucia")
  
```


```{r IA7, fig.height=4}

datos.plot <- datos.minist.andal %>% 
  filter(!is.na(Tasa.7d)) 

ggplot(datos.plot) +
  geom_line(aes(Fecha, Tasa.7d), size = 2) +
  annotate("text", x = 4 + max(datos.plot$Fecha), 
           y = datos.plot$Tasa.7d[nrow(datos.plot)],
           label = round(datos.plot$Tasa.7d[nrow(datos.plot)])) +
  geom_ribbon(aes(x = Fecha, ymin = 0, ymax = 10), fill = "#4daf4a", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 10, ymax = 25), fill = "#ffff33", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 25, ymax = 75), fill = "#ff7f00", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 75, ymax = 125), fill = "#e41a1c", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 125, ymax = max(Tasa.7d)), 
              fill = "#984ea3", alpha = 0.3) +
  labs(x = "", y = "",
       title = "Incidencia Acumulada 7 días",
       subtitle = "Casos confirmados en los últimos 7 días por cada 100.000 habitantes",
       caption = "https://tiny.cc/COVID19-Andalucia")
  
```



```{r IA14.65a, fig.height=4}

datos.plot <- datos.minist.andal %>% 
  filter(!is.na(Tasa.14d.65a)) %>% 
  filter(Fecha < Sys.Date() - 3)

ggplot(datos.plot) +
  geom_line(aes(Fecha, Tasa.14d.65a), size = 2) +
  annotate("text", x = 3 + max(datos.plot$Fecha), 
           y = datos.plot$Tasa.14d.65a[nrow(datos.plot)],
           label = round(datos.plot$Tasa.14d.65a[nrow(datos.plot)])) +
  geom_ribbon(aes(x = Fecha, ymin = 0, ymax = 20), fill = "#4daf4a", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 20, ymax = 50), fill = "#ffff33", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 50, ymax = 100), fill = "#ff7f00", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 100, ymax = 150), fill = "#e41a1c", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 150, ymax = max(Tasa.14d.65a)), 
              fill = "#984ea3", alpha = 0.3) +
  labs(x = "", y = "",
       title = "Incidencia Acumulada 14 días (> 65 años)",
       subtitle = "Casos confirmados en los últimos 14 días por cada 100.000 habitantes > 65 años",
       caption = "https://tiny.cc/COVID19-Andalucia")
  
```


```{r IA7.65a, fig.height=4}

datos.plot <- datos.minist.andal %>% 
  filter(!is.na(Tasa.7d.65a)) %>% 
  filter(Fecha < Sys.Date() - 3)

ggplot(datos.plot) +
  geom_line(aes(Fecha, Tasa.7d.65a), size = 2) +
  annotate("text", x = 3 + max(datos.plot$Fecha), 
           y = datos.plot$Tasa.7d.65a[nrow(datos.plot)],
           label = round(datos.plot$Tasa.7d.65a[nrow(datos.plot)])) +
  geom_ribbon(aes(x = Fecha, ymin = 0, ymax = 10), fill = "#4daf4a", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 10, ymax = 25), fill = "#ffff33", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 25, ymax = 50), fill = "#ff7f00", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 50, ymax = 75), fill = "#e41a1c", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 75, ymax = max(Tasa.7d.65a)), 
              fill = "#984ea3", alpha = 0.3) +
  labs(x = "", y = "",
       title = "Incidencia Acumulada 7 días (> 65 años)",
       subtitle = "Casos confirmados en los últimos 7 días por cada 100.000 habitantes > 65 años",
       caption = "https://tiny.cc/COVID19-Andalucia")
  
```



```{r Positividad, fig.height=4}

datos.plot <- datos.minist.andal %>% 
  filter(!is.na(Positividad.7d)) 

ggplot(datos.plot) +
  geom_line(aes(Fecha, Positividad.7d), size = 2) +
  annotate("text", x = 1 + max(datos.plot$Fecha), 
           y = datos.plot$Positividad.7d[nrow(datos.plot)],
           label = round(datos.plot$Positividad.7d[nrow(datos.plot)])) +
  geom_ribbon(aes(x = Fecha, ymin = 0, ymax = 4), fill = "#4daf4a", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 4, ymax = 7), fill = "#ffff33", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 7, ymax = 10), fill = "#ff7f00", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 10, ymax = 15), fill = "#e41a1c", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 15, ymax = 20), 
              fill = "#984ea3", alpha = 0.3) +
  labs(x = "", y = "",
       title = "Positividad de las PCR + Test Antígeno",
       subtitle = "% Positivos última semana",
       caption = "https://tiny.cc/COVID19-Andalucia")
  
```


```{r Trazabilidad, fig.height=4}

datos.plot <- datos.minist.andal %>% 
  filter(!is.na(Trazabilidad)) 

ggplot(datos.plot) +
  geom_line(aes(Fecha, Trazabilidad), size = 2) +
  annotate("text", x = 1 + max(datos.plot$Fecha), 
           y = datos.plot$Trazabilidad[nrow(datos.plot)],
           label = round(datos.plot$Trazabilidad[nrow(datos.plot)])) +
  geom_ribbon(aes(x = Fecha, ymin = 80, ymax = 100), fill = "#4daf4a", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 65, ymax = 80), fill = "#ffff33", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 50, ymax = 65), fill = "#ff7f00", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 30, ymax = 50), fill = "#e41a1c", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 0, ymax = 30), 
              fill = "#984ea3", alpha = 0.3) +
  labs(x = "", y = "",
       title = "Trazabilidad de los casos",
       subtitle = "% casos que son contactos de positivo conocido",
       caption = "https://tiny.cc/COVID19-Andalucia")
  
```

<br>

### Bloque 2: Capacidad Asistencial

<br>

```{r ocup.hospi, fig.height=4}

datos.plot <- datos.minist.andal %>% 
  filter(!is.na(`%CamasOcup.Minist`)) 

ggplot(datos.plot) +
  geom_line(aes(Fecha, `%CamasOcup.Minist`), size = 2) +
  annotate("text", x = 1 + max(datos.plot$Fecha), 
           y = datos.plot$`%CamasOcup.Minist`[nrow(datos.plot)],
           label = round(datos.plot$`%CamasOcup.Minist`[nrow(datos.plot)])) +
  geom_ribbon(aes(x = Fecha, ymin = 0, ymax = 2), fill = "#4daf4a", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 2, ymax = 5), fill = "#ffff33", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 5, ymax = 10), fill = "#ff7f00", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 10, ymax = 15), fill = "#e41a1c", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 15, ymax = 20), 
              fill = "#984ea3", alpha = 0.3) +
  labs(x = "", y = "",
       title = "Ocupación hospitalaria",
       subtitle = "% camas ocupadas por COVID-19",
       caption = "https://tiny.cc/COVID19-Andalucia")

```


```{r ocup.uci, fig.height=4}

datos.plot <- datos.minist.andal %>% 
  filter(!is.na(`%UCI.Minist`)) 

ggplot(datos.plot) +
  geom_line(aes(Fecha, `%UCI.Minist`), size = 2) +
  annotate("text", x = 1 + max(datos.plot$Fecha), 
           y = datos.plot$`%UCI.Minist`[nrow(datos.plot)],
           label = round(datos.plot$`%UCI.Minist`[nrow(datos.plot)])) +
  geom_ribbon(aes(x = Fecha, ymin = 0, ymax = 5), fill = "#4daf4a", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 5, ymax = 10), fill = "#ffff33", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 10, ymax = 15), fill = "#ff7f00", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 15, ymax = 25), fill = "#e41a1c", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 25, ymax = 30), 
              fill = "#984ea3", alpha = 0.3) +
  labs(x = "", y = "",
       title = "Ocupación UCI",
       subtitle = "% camas UCI ocupadas por COVID-19",
       caption = "https://tiny.cc/COVID19-Andalucia")

```

<br>


## Resumen de casos, ingresos y defunciones

<br>

```{r fig.resumen, out.width='100%', fig.height=6}

datos.andal.long <- datos.andal %>%
  select(Fecha, Territorio, ConfirmadosPCR, Hospitalizados, UCI, Defunciones) %>%
  tidyr::pivot_longer(cols = ConfirmadosPCR:Defunciones, names_to = "indic") %>%
  filter(indic != "Curados") %>%
  mutate(indic = ifelse(indic == "Hospitalizados", "Hospitalizaciones", indic)) %>%
  mutate(indic = ifelse(indic == "UCI", "Ingresos UCI", indic)) %>%
  mutate(indic = ifelse(indic == "ConfirmadosPCR", "Casos confirmados", indic)) %>%
  # mutate(indic = ifelse(indic == "CamasOcup", "Camas ocupadas", indic)) %>%
  mutate(indic = factor(indic, 
                        levels = c("Casos confirmados", "Hospitalizaciones", 
                                   "Ingresos UCI", "Defunciones")))

ggplot(datos.andal.long) +
  facet_wrap(~indic, ncol = 1, scales = "free_y") + 
  geom_col(aes(x = Fecha, y = value, fill = indic)) +
  scale_fill_manual(values = c("#ff7f00", "#377eb8", "#e41a1c", "grey40")) +
  labs(x = "", y = "Nº personas", caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(legend.position = "none") +
  scale_x_date(limits = c(as.Date("2020-03-01"), NA), date_breaks = "1 month", date_labels = "%b") +
  scale_y_continuous(sec.axis = dup_axis(name = ""))

```

<br>

Evolución en las **últimas dos semanas**:

```{r fig.resumen.14d, out.width='100%', fig.height=6}

datos.andal.long %>%
  filter(Fecha > as.Date(Sys.Date() - 16)) %>%
ggplot() +
  facet_wrap(~indic, ncol = 1, scales = "free_y") + 
  geom_col(aes(x = Fecha, y = value, fill = indic)) +
  scale_fill_manual(values = c("#ff7f00", "#377eb8", "#e41a1c", "grey40")) +
  labs(x = "", y = "Nº personas\n", caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(legend.position = "none") +
  scale_x_date(date_breaks = "2 days", date_labels = "%d %b") +
  scale_y_continuous(sec.axis = dup_axis(name = ""))

```

**NOTA**: el retraso (de varios días) en las notificaciones hace que las curvas parezcan a menudo descendentes. A menudo, en los días siguientes se añaden nuevos casos, ingresos y defunciones asignados a fechas pasadas. Por tanto, un descenso en, por ejemplo, el número de casos u hospitalizaciones en los últimos días **no debe interpretarse como un descenso** en la intensidad de la pandemia hasta que los datos sean consolidados en los próximos días.

<br>



```{r datos.last, out.width='100%'}

## Existen discordancias entre serie suministrada al ministerio y la depurada por la Junta a posteriori. 
## La de la Junta lleva mucho retraso últimamente. Paso a usar la del ministerio

# ## Usando la serie de la Junta (1 día de retraso)
# datos.last <- datos.andal %>%
#   dplyr::select(Fecha:Defunciones) %>%#
#   bind_rows(datos.provs) %>%
#   dplyr::select(-ConfirmadosTotal) %>%
#   filter(Fecha == max(Fecha)) %>%
#   mutate_at(3:ncol(.), function(x) {ifelse(is.na(x), 0, x)}) %>% 
#   rename(`Confirmados PCR/Antígeno` = ConfirmadosPCR)
# 
# 
# kable(datos.last[, -1])


ayer <- datos.minist %>% 
  group_by(Territorio) %>% 
  mutate(across(.cols = c(Confirmados, Hospitalizados:Recuperados), 
         .fns = function(x) {x - lag(x)})) %>% 
  mutate(Fecha.lag = Fecha - lag(Fecha))

last.day.valid <- ayer %>% 
  filter(Fecha.lag < 2) %>% 
  filter(Fecha == max(Fecha)) %>% 
  select(-Fecha.lag)
 
```


**DATOS DEL DÍA:** `r unique(last.day.valid$Fecha)`

```{r out.width='100%'}

last.day.valid %>% 
  select(Territorio, Casos = Confirmados, Casos.14d = `Confirmados 14d`,
         Casos.7d = `Confirmados 7d`, Ingresos = Hospitalizados, UCI, Defunciones) %>% 
  kable()

```

<br>



**DATOS ACUMULADOS:**

```{r datos.acum, out.width='100%'}
# Estos datos normalmente un día por delante de la serie de la Junta

datos.minist %>%
  filter(Fecha == max(Fecha)) %>%
  select(Territorio, Casos = Confirmados, 
         #Casos.14d = `Confirmados 14d`, Casos.7d = `Confirmados 7d`, 
         Ingresos = Hospitalizados, UCI, Defunciones) %>% 
  kable()

```

(Confirmados = Confirmados mediante PCR o test de antígeno)

<br>



## Casos confirmados

<br>

En primer lugar se muestra el número de casos confirmados diariamente mediante PCR o test rápido de antígeno (Pruebas Diagnósticas de Infección Activa). 

<br>

```{r casos.pcr.datadista, fig.height=4, out.width='100%', eval=FALSE}

download.file("https://raw.githubusercontent.com/datadista/datasets/master/COVID%2019/ccaa_covid19_datos_isciii.csv", destfile = "datos/datadista_ccaa_covid19_datos_isciii.csv")

casos.pcr <- readr::read_csv("datos/datadista_ccaa_covid19_datos_isciii.csv", guess_max = 10000) %>%
  dplyr::filter(CCAA == "Andalucía") %>%
  rename(PCR = `PCR+`, TestAc = `TestAc+`) %>%
  mutate(Casos = ifelse(is.na(Casos), PCR + TestAc, Casos)) %>%
  mutate(PCR = ifelse(is.na(PCR), Casos, PCR)) %>% # assuming before 14 Abril all/most cases were PCR, no TestAc
  mutate(PCR.new = PCR - lag(PCR))
  

ggplot(casos.pcr) +
  geom_col(aes(x = Fecha, y = PCR.new), 
            fill = "#ff7f00") +
  scale_y_continuous(limits = c(0, NA), n.breaks = 6) +
  labs(x = "", y = "Nuevas detecciones\n",
       title = "Casos de COVID-19 confirmados diariamente por PCR en Andalucía",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(panel.grid.minor.y = element_line(size = rel(0.5)))

```



```{r casos.pcr, fig.height=4, out.width='100%'}

ggplot(datos.andal) +
  geom_col(aes(x = Fecha, y = ConfirmadosPCR), 
            fill = "#ff7f00") +
  scale_y_continuous(limits = c(0, NA), sec.axis = dup_axis(name = "")) +
  labs(x = "", y = "Nuevas detecciones\n",
       title = "Casos diarios de COVID-19 en Andalucía",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(panel.grid.minor.y = element_line(size = rel(0.5))) +
  scale_x_date(limits = c(as.Date("2020-03-01"), NA), 
               date_breaks = "1 month", date_labels = "%b")

```

<br>

Debe tenerse en cuenta que el [número de casos confirmados depende en gran medida del número de test realizados](https://ourworldindata.org/covid-testing). Por tanto, un aumento o disminución en el número de casos confirmados puede deberse a haber realizado más o menos tests, no a variaciones en la incidencia de la enfermedad. Durante los primeros meses de la pandemia (Marzo-Mayo 2020) solo se realizó PCR a los pacientes más graves, dejando sin detectar probablemente [más del 90% de los casos](https://www.eldiario.es/sociedad/porcentaje-poblacion-contagiada-explosivo-COVID-19_0_1026798481.html), por lo que el número de casos diarios no es comparable entre periodos con distinta intensidad de muestreo como la primavera y el otoño. 


<br>

Casos confirmados por PCR o test de antígeno en los últimos 14 días:

<br>

```{r casos.pcr.14d, fig.height=4, out.width='100%'}

datos.andal %>%
  filter(Fecha > as.Date(Sys.Date() - 16)) %>%
ggplot() +
  geom_col(aes(x = Fecha, y = ConfirmadosPCR), 
            fill = "#ff7f00") +
  scale_y_continuous(limits = c(0, NA)) +
  labs(x = "", y = "Nuevas detecciones\n",
       title = "Casos diarios de COVID-19 en Andalucía",
       subtitle = "Últimos 14 días",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(panel.grid.minor.y = element_line(size = rel(0.5))) +
  scale_x_date(date_breaks = "2 days", date_labels = "%d %b") +
  geom_text(aes(Fecha, y = ConfirmadosPCR + 130, label = ConfirmadosPCR),
            data = subset(datos.andal, Fecha > (Sys.Date() - 16)), size = 4) 

```

<br>

**NOTA**: el retraso (de varios días) en las notificaciones hace que las curvas parezcan a menudo descendentes. Frecuentemente, en los días siguientes se añaden nuevos casos asignados a fechas pasadas. Por tanto, **un descenso en el número de casos en los últimos días no debe interpretarse como un descenso en la intensidad de la pandemia** hasta que los datos sean consolidados en los próximos días.

<br>

```{r casos_Andalucia, fig.height=4, out.width='100%', eval = FALSE}

# Además de PCR, la Junta de Andalucía está realizando test rápidos, que sirven para detectar personas que han sido probablemente contagiadas por el virus (aunque actualmente puedan no mostrar síntomas o no tener carga viral significativa). Las gráficas de abajo incluyen tanto los casos detectados mediante PCR como mediante test serológicos (anticuerpos).
# 
# <br>


ggplot(datos.andal) +
  geom_col(aes(x = Fecha, y = ConfirmadosTotal), 
            fill = "#ff7f00") +
  geom_line(aes(x = Fecha, y = Ntest.dia), 
            size = 1, colour = "grey70") + 
  scale_y_continuous(limits = c(0, NA), n.breaks = 6) +
  labs(x = "", y = "Nuevas detecciones\n",
       title = "Casos de COVID-19 confirmados diariamente en Andalucía",
       subtitle = "La línea gris representa el número de test (PCR + serológicos) realizados diariamente",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(panel.grid.minor.y = element_line(size = rel(0.5)))

```


```{r ncasos.ntest, out.width='100%', fig.height=4, eval=FALSE}

## NB: algún día (ej. 4 Mayo hay más confirmados que test!)

ggplot(datos.andal) +
  geom_point(aes(Ntest.dia, ConfirmadosTotal), 
             size = 3, colour = "#ff7f00") +
  scale_y_continuous(limits = c(0, NA), 
                     name = "Número de casos confirmados\n") +
  scale_x_continuous(limits = c(0, NA),
                     name = "\nNúmero de test realizados") +
  labs(title = "Relación entre el número de casos confirmados\ny el número de test realizados diariamente",
       caption = "https://tiny.cc/COVID19-Andalucia")
```


```{r prop.positivos, fig.height=4, out.width = '100%', eval=FALSE}

# La proporción de casos positivos respecto al total de test realizados también [puede informarnos](https://www.theatlantic.com/technology/archive/2020/04/us-coronavirus-outbreak-out-control-test-positivity-rate/610132/) sobre la incidencia de la enfermedad. 
# 
# <br>
  
  
sec.axis.factor = 30

ggplot(datos.andal) +
  # geom_ribbon(aes(x = Fecha, ymin = prop.ci.low, ymax = prop.ci.up),
  #             fill = "#ff7f00", alpha = 0.3) +
  geom_col(aes(x = Fecha, y = Prop.Positivos), 
            fill = "#ff7f00") +
  geom_line(aes(x = Fecha, y = (Ntest.dia/sec.axis.factor)), 
            colour = "grey70", size = 1.5) +
  # geom_text(aes(x = Fecha, y = 5, label = Ntest.dia), 
  #           colour = "#ff7f00", alpha = 0.8) +
  scale_y_continuous(limits = c(0, 100), 
                     sec.axis = sec_axis(trans = ~ ((.*sec.axis.factor)), 
                                         breaks = seq(0, 3000, by = 500),
                                         name = "Número de test\n")) +
  scale_x_date(limits = c(as.Date("2020-03-26"), as.Date("2020-05-13"))) +
  labs(x = "", y = "Porcentaje de tests positivos\n",
       title = "Porcentaje de tests que dan positivo en Andalucía",
       subtitle = "La línea gris representa el número de test realizados diariamente (eje derecho)",
       caption = "https://tiny.cc/COVID19-Andalucia")


# (La Junta de Andalucía ha dejado de proporcionar datos diarios del número de personas testadas, por lo que esta gráfica ha dejado de actualizarse desde el 12 de Mayo)

```


<br>

A continuación se presentan los **casos confirmados mediante PCR o test de antígeno en cada provincia**:

<br>

```{r casos_provincias, out.width = '100%', fig.height=6}

ggplot(datos.provs) +
  facet_wrap(~Territorio, scales = "free_y", ncol = 2) +
  geom_col(aes(x = Fecha, y = ConfirmadosPCR), 
            fill = "#ff7f00") +
  ylim(0, NA) +
  labs(x = "", y = "Nuevas detecciones\n",
       title = "Casos diarios de COVID-19 en cada provincia",
       subtitle = "Para facilitar la visualización de tendencias la escala del eje vertical es diferente en cada provincia",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(axis.text.x = element_text(size = 8)) +
  scale_x_date(limits = c(as.Date("2020-03-01"), NA))

```


<br>

Y en los últimos 14 días:

<br>

```{r casos_provincias.14d, out.width = '100%', fig.height=6}

datos.provs %>%
  filter(Fecha > as.Date(Sys.Date() - 16)) %>%
ggplot() +
  facet_wrap(~Territorio, ncol = 2) +
  geom_col(aes(x = Fecha, y = ConfirmadosPCR), 
            fill = "#ff7f00") +
  labs(x = "", y = "Nuevas detecciones\n",
       title = "Casos diarios de COVID-19 en cada provincia",
       subtitle = "Últimos 14 días",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(axis.text.x = element_text(size = 8)) +
  scale_x_date(date_breaks = "4 days", date_labels = "%d %b") +
  scale_y_continuous(limits = c(0, NA), sec.axis = dup_axis(name = ""))

```

<br>

Pulse [aquí](#datos-por-municipio) para ver los **datos por municipio**. 

<br>


```{r distritos, eval=FALSE}
# 
# distritos.old <- gsheet::gsheet2tbl("https://docs.google.com/spreadsheets/d/1vH3y_4bL9n1sXOQjA91m8eqfbpCI-a8KV3cWXfQY3cI")
# 
# distritos <- distritos %>%
#   group_by(nombre) %>%
#   mutate(casos.dia = confirmados - lag(confirmados)) %>%
#   mutate(casos.dia = ifelse(fecha == as.Date("2020-04-11"), NA, casos.dia))

#stopifnot(distritos$casos.dia >=0)

```

```{r eval = FALSE}

distritos <- readxl::read_excel("datos/distritos_sanitarios.xlsx")

distri.data <- read_csv("datos/datos_distritos_confirmados.csv",
                        col_types = "Dccccci")

if (!fecha.distri %in% distri.data$Fecha) {
  
  distri.data.new <- readr::read_csv2("datos/datos_distritos_confirmados_dia.csv", 
                                      col_types = "cccci-",
                                      locale = locale(date_names = "es", 
                                                      decimal_mark = ",",
                                                      grouping_mark = ".",
                                                      date_format = "%d/%m/%Y"),
                                      skip_empty_rows = TRUE)
  
  distri.data.new <- distri.data.new %>%
    mutate(Fecha = fecha.distri) %>%
    rename(Casos = Valor) %>%
    dplyr::select(-Medida) %>%
    dplyr::select(Fecha, everything()) 
  
  
  # checks
  distri.data.new %>%
    verify(names(.) == c("Fecha", "Territorio", "Edad", "Sexo", "Casos")) %>%
    verify(sort(unique(.$Territorio)) == sort(distritos$Territorio)) %>%
    assert(within_bounds(0, Inf), Casos)
  
  # join
  distri.data.new <- distri.data.new %>%
    left_join(distritos, by = "Territorio") %>%
    dplyr::select(Fecha, Territorio, nombre.corto, provincia, everything()) %>%
    arrange(Fecha, provincia, Territorio)
  
  
  # add to former dataset
  distri.data <- bind_rows(distri.data, distri.data.new)
  
  # save
  write_csv(distri.data, "datos/datos_distritos_confirmados.csv")
  
}

```

```{r eval=FALSE}
# ## 23-04-2020: La Junta cambia nombre de distritos con nombre == a provincia
# distri.data <- distri.data %>%
#   mutate(Territorio = case_when(
#     Territorio == "Almería" ~ "Almería (distrito)",
#     Territorio == "Córdoba" ~ "Córdoba (distrito)",
#     Territorio == "Granada" ~ "Granada (distrito)",
#     Territorio == "Jaén" ~ "Jaén (distrito)",
#     Territorio == "Málaga" ~ "Málaga (distrito)",
#     Territorio == "Sevilla" ~ "Sevilla (distrito)",
#     TRUE ~ Territorio
#   ))

# distri.data <- distri.data %>%
#   mutate(nombre.corto = ifelse(nombre.corto == "Axarquia", "Axarquía", nombre.corto))

# distri.data <- distri.data %>%
#   filter(Fecha != "2020-04-22")
```

```{r casos.distri, out.width='100%', fig.height=7, eval=FALSE}

distri.data <- read_csv("datos/datos_distritos_confirmados.csv",
                        col_types = "Dccccci")

distri.data2plot <- distri.data %>%
  filter(Edad == "TOTAL", Sexo == "Ambos sexos") %>%
  filter(Fecha > as.Date("2020-04-10")) %>%
  group_by(Territorio) %>%
  mutate(Casos.new = Casos - lag(Casos)) %>%
  ungroup() %>%
  mutate(Casos.new = ifelse(Fecha == as.Date("2020-04-11"), NA, Casos.new))

distri.last <- dplyr::filter(distri.data2plot, Fecha == max(Fecha))

set.seed(5)

ggplot(distri.data2plot) +
  aes(x = Fecha, y = Casos.new) +
  facet_wrap(~provincia, ncol = 2) +
  geom_line(aes(group = nombre.corto, colour = nombre.corto), size = 1.5) +
  theme(legend.position = "none") +
  geom_point(data = distri.last, aes(colour = nombre.corto), size = 1.5) +
  scale_color_manual(values = sample(colorRampPalette(RColorBrewer::brewer.pal(n = 9, "Set1")[-6])(100))) +
  ggrepel::geom_text_repel(data = distri.last,
                           aes(label = nombre.corto, colour = nombre.corto), 
                           size = 2.5, nudge_x = 0.4, 
                           segment.size = 0.2, segment.alpha = 0.5) +
  scale_x_date(expand = expansion(mult = c(0, 0.5))) +
  labs(x = "", y = "Casos confirmados\n",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(strip.text = element_text(size = 12))

```


### Mapas


```{r mapa_distritos, out.width='100%', eval=FALSE}
casos.dist <- readxl::read_excel("datos/datos_brutos.xlsx", sheet = "distritos")

library(sf)

distritos <- st_read("Distritos/Distritos_2018.shp", 
                     stringsAsFactors = FALSE, quiet = TRUE) %>%
  mutate(CODIST = as.numeric(CODIST))

casos.dist <- left_join(select(distritos, CODIST, nombre),
                        select(casos.dist, CODIST, nombre, casos, fecha),
                        by = c("CODIST", "nombre"))


library(mapview)
mapviewOptions(legend.pos = "bottomleft")

mapview(casos.dist, zcol = "casos", 
        col.regions = colorRampPalette(RColorBrewer::brewer.pal(9, "YlOrRd")),
        alpha.regions = 0.9,
        map.types = "CartoDB.Positron",
        layer.name = "Casos",
        popup = leafpop::popupTable(casos.dist, 
                                    zcol = c("nombre", "casos", "fecha"), 
                           row.numbers = FALSE, feature.id = FALSE)) 

# ggplot(casos.dist) +
#   geom_sf(aes(fill = casos)) +
#   scale_fill_distiller(type = "seq", palette = "YlGnBu", direction = 1)
        
```

Este mapa de **casos confirmados por PCR o test de antígeno en los últimos 14 días** es útil para saber dónde se encuentran los brotes activos en la actualidad. Pasa el cursor sobre el mapa para ver los valores concretos por municipio.

```{r mapamunis_PCR_14d, out.width='100%'}

muni.data <- readr::read_csv("datos/municipios.csv", guess_max = 200000) %>%
  filter(Fecha == max(Fecha)) %>%
  rename(PROVINCIA = Provincia, MUNICIPIO = Municipio) %>%
  mutate(Confirmados.PCR.TA.14d = ifelse(Confirmados.PCR.TA.14d < 1, NA, Confirmados.PCR.TA.14d))



library(sf)

# muni.gpkg <- st_read("datos/municipios.gpkg", 
#                      stringsAsFactors = FALSE, quiet = TRUE) 
# 
# muni.lite <- rmapshaper::ms_simplify(muni.gpkg, keep_shapes = TRUE, keep = 0.01)
# 
# st_write(muni.lite, "datos/municipios_lite.gpkg")

muni.lite <- st_read("datos/municipios_lite.gpkg", 
                     stringsAsFactors = FALSE, quiet = TRUE)

muni.14d <- left_join(select(muni.lite, PROVINCIA, MUNICIPIO),
                      select(muni.data, PROVINCIA, MUNICIPIO, Confirmados.PCR.TA.14d),
                      by = c("PROVINCIA", "MUNICIPIO")) %>%
  mutate(casos = ifelse(is.na(Confirmados.PCR.TA.14d), 0, Confirmados.PCR.TA.14d),
         lab = paste(MUNICIPIO, casos, sep = ": "))

library(ggiraph)

mapa <- 
  ggplot(muni.14d) +
  ggiraph::geom_sf_interactive(aes(fill = Confirmados.PCR.TA.14d, tooltip = lab), 
                               colour = "grey85", size = 0.1) +
  scale_fill_distiller(type = "seq", palette = "Oranges", direction = 1, 
                       na.value = "white") +
  #theme_minimal() +
  theme(axis.text = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "Casos confirmados en cada municipio",
       subtitle = "Últimos 14 días",
       caption = "https://tiny.cc/COVID19-Andalucia")

girafe(ggobj = mapa)

```


Este mapa muestra los casos confirmados por PCR o test de antígeno en los últimos 14 días **por cada 100.000 habitantes**:

```{r mapamunis_PCR_14d_hab, out.width='100%'}

muni.14d.hab <- left_join(select(muni.lite, PROVINCIA, MUNICIPIO),
                      select(muni.data, PROVINCIA, MUNICIPIO, Conf14d_100.000hab),
                      by = c("PROVINCIA", "MUNICIPIO")) %>%
  mutate(casos = ifelse(is.na(Conf14d_100.000hab), 0, round(Conf14d_100.000hab)),
         lab = paste(MUNICIPIO, casos, sep = ": "))

mapa <- 
  ggplot(muni.14d.hab) +
  ggiraph::geom_sf_interactive(aes(fill = Conf14d_100.000hab, tooltip = lab), 
                               colour = "grey85", size = 0.1) +
  scale_fill_distiller(type = "seq", palette = "Oranges", direction = 1, 
                       na.value = "white") +
  #theme_minimal() +
  theme(axis.text = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "Casos por 100.000 habitantes en cada municipio",
       subtitle = "Últimos 14 días",
       caption = "https://tiny.cc/COVID19-Andalucia")

girafe(ggobj = mapa)

```



La Junta de Andalucía ha comenzado a visualizar los datos diarios por provincia, distrito sanitario y municipio [aquí](http://www.juntadeandalucia.es/institutodeestadisticaycartografia/salud/COVID19.html).

<br>




### Porcentaje de PCR positivas

Aquí se muestra el número de PCR realizadas en Andalucía cada semana (según los datos ofrecidos por [Datadista](https://github.com/datadista/datasets/tree/master/COVID%2019)), el número de casos detectados esa semana y, en consecuencia, el porcentaje de PCR positivas. Si el porcentaje de pruebas positivas es elevado es probable que no se estén detectando todos los casos y por tanto no se estén cortando bien las cadenas de transmisión. La OMS recomienda que este porcentaje se mantenga por debajo del 5%. 


```{r test.posit, out.width='100%'}

ntest <- readr::read_csv("https://raw.githubusercontent.com/datadista/datasets/master/COVID%2019/ccaa_covid19_test_realizados.csv") %>%
  filter(cod_ine == "01") %>%
  select(Fecha, cod_ine, CCAA, PCR)

# datos.andal$casos.7d <- zoo::rollsumr(datos.andal$ConfirmadosPCR, k = 7, fill = NA)

datos.andal <- datos.andal %>%
  mutate(casos.acum = cumsum(ConfirmadosPCR))

ntest <- datos.andal %>%
  select(Fecha, casos.acum) %>%
  right_join(ntest, by = "Fecha") %>%
  arrange(Fecha) %>%
  mutate(pcr.7d = PCR - lag(PCR),
         casos.7d = casos.acum - lag(casos.acum)) %>%
  mutate(pos.percent = 100*round(casos.7d/pcr.7d, digits = 3)) %>%
  select(Fecha, pcr.7d, casos.7d, pos.percent) %>%
  tidyr::pivot_longer(cols = pcr.7d:pos.percent) %>%
  mutate(name = case_when(
    name =="pcr.7d" ~ "PCR semanales realizadas",
    name == "casos.7d" ~ "Casos confirmados",
    name == "pos.percent" ~ "Porcentaje de PCR positivas"
  )) %>%
  mutate(name = factor(name, levels = c("PCR semanales realizadas", "Casos confirmados", "Porcentaje de PCR positivas"))) %>%
  filter(Fecha > "2020-04-23")

ggplot(ntest) + 
  facet_wrap(~name, ncol = 1, scales = "free_y") +
  geom_line(aes(Fecha, value, colour = name), size = 2) +
  ylim(0, NA) +
  scale_colour_manual(values = c("grey60", "#ff7f00", "black")) +
  theme(legend.position = "none") +
  labs(x = "", y = "",
       #title = "Porcentaje de personas con PCR positiva",
       caption = "https://tiny.cc/COVID19-Andalucia")
  

```


<br>



### Casos confirmados por fecha y rango de edad

Esta figura representa los rangos de edad de los casos confirmados por PCR o test de antígeno a lo largo del tiempo (desde el 15 de Marzo de 2020). 

Mientras que en los meses de Marzo a Mayo sólo se detectaron los casos más graves, normalmente asociados a personas de mayor edad (>45 años), en la segunda oleada (a partir de Agosto), los casos comenzaron en personas jóvenes para extenderse paulatinamente a todas las edades.

<br>


```{r casos.edad.heatmap, out.width='100%', fig.height=2.5}


casos.edad.fecha %>%
  filter(Fecha > "2020-03-14") %>%
  ggplot() +
  geom_tile(aes(x = Fecha, y = edades, fill = Casos)) +
  scale_fill_viridis_c() +
  labs(y = "Edad", x = "",
       title = "Edad de los casos confirmados",
       caption = "https://tiny.cc/COVID19-Andalucia",
       fill = "Casos\ndiarios") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b")

```

<br>


```{r casos.edad.anim, out.width='100%', eval = FALSE}

library(gganimate)

edad.anim.df <-
  casos.edad.fecha %>%
  mutate(edades = factor(edades,
                         levels = (c("0 - 14", "15 - 29", "30 - 44", "45 - 64", "65 - 84", "85 y más")))) %>%
  filter(Fecha >= "2020-07-01")
    
edad.anim <- 
  ggplot(edad.anim.df) +
  geom_col(aes(x = edades, y = Casos), fill = "#ff7f00") +
  #transition_states(Fecha, wrap = FALSE) +
  transition_manual(frames = Fecha) +
  labs(y = "Número de casos diarios \n", x = "Edad",
       title = "Edad de los casos confirmados por PCR",
       subtitle = "{current_frame}",
       caption = "https://tiny.cc/COVID19-Andalucia") 

animate(edad.anim, height = 4, width = 5, units = "in", res = 150, 
        rewind = FALSE, 
        nframes = length(unique(edad.anim.df$Fecha)),
        fps = 8)

anim_save("edad_casos_anim.gif")

    
```


Aquí se representan los mismos datos (casos diarios confirmados por categoría de edad) usando curvas suavizadas mediante *loess* (local polynomial regression) para reducir la variación diaria y facilitar la visualización de tendencias:


```{r casos.edad.lines, out.width='100%'}

# ggplot(casos.edad.fecha) +
#   geom_line(aes(Fecha, Casos, colour = edades))

casos.edad.fecha$edades <- factor(casos.edad.fecha$edades, 
                                  levels = rev(levels(casos.edad.fecha$edades)))

ggplot(casos.edad.fecha) +
  geom_smooth(aes(Fecha, Casos, colour = edades), 
              span = 0.3, se = FALSE, show.legend = TRUE) +
  scale_x_date(limits = c(as.Date("2020-07-01"), max(casos.edad.fecha$Fecha) - 3), expand = c(0, 20),
               date_breaks = "1 month", date_labels = "%b") +
  labs(y = "Casos\n", x = "",
       title = "Casos diarios por franja de edad",
       caption = "https://tiny.cc/COVID19-Andalucia",
       colour = "Edad") +
  scale_color_manual(values = c("#ffff33", "#e41a1c", "#984ea3",
                                "#377eb8", "#4daf4a", "#999999")) +
  # geom_text(data = casos.edad.last, aes(Fecha - 20, Casos, label = edades)) +
  theme(legend.title = element_text(hjust = 0.5))
```

<br>

La siguiente figura muestra la Incidencia Acumulada (número de casos en los últimos 14 días por cada 100.000 habitantes) teniendo en cuenta el número de personas en cada franja de edad:

```{r ia14.edad}

ggplot(casos.edad.fecha) +
  geom_smooth(aes(Fecha, IA.14d, colour = edades), 
              span = 0.3, se = FALSE, show.legend = TRUE) +
  scale_x_date(limits = c(as.Date("2020-07-01"), max(casos.edad.fecha$Fecha) - 3), 
               expand = c(0, 20),
               date_breaks = "1 month", date_labels = "%b") +
  labs(y = "Incidencia Acumulada\n", x = "",
       title = "Incidencia Acumulada 14 días por franja de edad",
       subtitle = "Casos confirmados en los últimos 14 días por cada 100.000 habitantes",
       caption = "https://tiny.cc/COVID19-Andalucia",
       colour = "Edad") +
  scale_color_manual(values = c("#ffff33", "#e41a1c", "#984ea3",
                                "#377eb8", "#4daf4a", "#999999")) +
  # geom_text(data = casos.edad.last, aes(Fecha - 20, Casos, label = edades)) +
  theme(legend.title = element_text(hjust = 0.5))
```



```{r casos.sexo.edad.5a, eval=FALSE}

# Esta figura representa la variación semanal en número de casos detectados según sexo y edad (en intervalos de 5 años): 
  
datos.edad.sexo <- readr::read_csv("datos/datos_edad_sexo.csv") %>% 
  filter(Fecha > as.Date("2020-10-21")) %>% 
  mutate(edades = str_replace(Edad, "De ", "")) %>%
  mutate(edades = str_replace(edades, " a ", " - ")) %>%
  mutate(edades = str_replace(edades, " años", "")) %>% 
  mutate(edades = str_replace(edades, " y más", "+")) %>% 
  mutate(edades = factor(edades, levels = gtools::mixedsort(unique(edades))))

casos.sexo.edad.5a <- datos.edad.sexo %>% 
  select(Fecha, edades, Sexo, Confirmados) %>% 
  group_by(edades, Sexo) %>% 
  mutate(Casos.week = Confirmados - lag(Confirmados)) %>% 
  filter(Fecha > as.Date("2020-10-22"))

ggplot(casos.sexo.edad.5a) + 
  geom_point(aes(x = Fecha, y = Casos.week, colour = Sexo)) +
  facet_wrap(~edades, ncol = 1) +
  scale_colour_manual(values = c("#ff7f00", "#984ea3")) +
  labs(y = "Casos\n", x = "",
       title = "Casos semanales por intervalo de edad",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(legend.position = "top", legend.title = element_blank())
  
  
```


## Ingresos en centros hospitalarios

<br>


```{r ingresos_Andalucia, fig.height=3, out.width='100%'}

ggplot(datos.andal) +
  geom_col(aes(x = Fecha, y = Hospitalizados), 
            fill = "#377eb8") +
  ylim(0, NA) +
  labs(x = "", y = "Nº Ingresos\n",
       title = "Hospitalizaciones diarias con COVID-19 en Andalucía",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_x_date(limits = c(as.Date("2020-03-01"), NA),
               date_breaks = "1 month", date_labels = "%b")

```


<br>


```{r ingresos_Andalucia.14d, fig.height=3, out.width='100%'}

ggplot(datos.andal) +
  geom_col(aes(x = Fecha, y = Hospitalizados), 
            fill = "#377eb8") +
  ylim(0, NA) +
  labs(x = "", y = "Nº Ingresos\n",
       title = "Hospitalizaciones diarias con COVID-19 en Andalucía",
       subtitle = "Últimos 14 días",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_x_date(limits = c(Sys.Date() - 16, NA), 
               date_breaks = "2 days", date_labels = "%d %b") +
  geom_text(aes(Fecha, y = Hospitalizados + 12, label = Hospitalizados),
            data = subset(datos.andal, Fecha > (Sys.Date() - 16))) 
  

```

<br>

**NOTA**: el retraso (de varios días) en las notificaciones hace que las curvas parezcan a menudo descendentes. Frecuentemente, en los días siguientes se añaden nuevos ingresos asignados a fechas pasadas. Por tanto, **un descenso en el número de hospitalizaciones en los últimos días no debe interpretarse como un descenso en la intensidad de la pandemia** hasta que los datos sean consolidados en los próximos días.


<br>


```{r ingresos_provincias, out.width='100%', fig.height=6}

ggplot(datos.provs) +
  facet_wrap(~Territorio, scales = "free_y", ncol = 2) +
  geom_col(aes(x = Fecha, y = Hospitalizados), 
            fill = "#377eb8") +
  ylim(0, NA) +
  labs(x = "", y = "Nº Ingresos\n",
       title = "Hospitalizaciones diarias con COVID-19 en cada provincia",
       subtitle = "Para facilitar la visualización de tendencias la escala del eje vertical es diferente en cada provincia",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(axis.text.x = element_text(size = 8)) +
  scale_x_date(limits = c(as.Date("2020-03-01"), NA))

```


<br>


```{r ingresos_provincias.14d, out.width='100%', fig.height=6}

ggplot(datos.provs) +
  facet_wrap(~Territorio, ncol = 2) +
  geom_col(aes(x = Fecha, y = Hospitalizados), 
            fill = "#377eb8") +
  labs(x = "", y = "Nº Ingresos\n",
       title = "Hospitalizaciones diarias con COVID-19 en cada provincia",
       subtitle = "Últimos 14 días",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(axis.text.x = element_text(size = 8)) +
  scale_x_date(limits = c(Sys.Date() - 16, NA), 
               date_breaks = "4 days", date_labels = "%d %b") +
  scale_y_continuous(limits = c(0, NA), sec.axis = dup_axis(name = ""))

```

<br>


### Ingresos en cuidados intensivos (UCI)

<br>


```{r uci_Andalucia, fig.height=3, out.width='100%'}

ggplot(datos.andal) +
  geom_col(aes(x = Fecha, y = UCI), fill = "#e41a1c") +
  ylim(0, NA) +
  labs(x = "", y = "Nº Ingresos UCI\n",
       title = "Ingresos diarios en UCI con COVID-19 en Andalucía",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_x_date(limits = c(as.Date("2020-03-01"), NA),
               date_breaks = "1 month", date_labels = "%b")

```


<br>


```{r uci_Andalucia.14d, fig.height=3, out.width='100%'}

ggplot(datos.andal) +
  geom_col(aes(x = Fecha, y = UCI), fill = "#e41a1c") +
  ylim(0, NA) +
  labs(x = "", y = "Nº Ingresos UCI\n",
       title = "Ingresos diarios en UCI con COVID-19 en Andalucía",
       subtitle = "Últimos 14 días",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_x_date(limits = c(Sys.Date() - 16, NA), 
               date_breaks = "2 days", date_labels = "%d %b") 

```
<br>

**NOTA**: el retraso (de varios días) en las notificaciones hace que las curvas parezcan a menudo descendentes. Frecuentemente, en los días siguientes se añaden nuevos ingresos asignados a fechas pasadas. Por tanto, **un descenso en el número de ingresos en los últimos días no debe interpretarse como un descenso en la intensidad de la pandemia** hasta que los datos sean consolidados en los próximos días.

<br>


```{r uci_provincias, out.width='100%', eval=FALSE}

ggplot(datos.provs) +
  facet_wrap(~Territorio, scales = "free_y", ncol = 2) +
  geom_col(aes(x = Fecha, y = UCI), fill = "#e41a1c") +
  ylim(0, NA) +
  labs(x = "", y = "Nº Ingresos UCI\n",
       title = "Ingresos diarios en UCI en cada provincia",
       subtitle = "Para facilitar la visualización de tendencias, la escala del eje vertical es diferente cada provincia",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(axis.text.x = element_text(size = 8))

```


### Camas ocupadas

<br>

Número de pacientes ingresados en centros hospitalarios, incluyendo aquellos en cuidados intensivos (UCI), según los datos proporcionados diariamente por la Junta de Andalucía. 

El pico máximo de camas ocupadas de la "primera ola" se alcanzó el 30 de Marzo con 2708 pacientes ingresados (438 en UCI). Ese número se rebasó el 2 de Noviembre con 2764 personas ingresadas (381 en UCI).

<br>

```{r camas.ocupadas, out.width='100%', fig.height=3}

camas <- readxl::read_excel("datos/camas_ocupadas.xlsx") %>%
  mutate(Fecha = as.Date(Fecha)) %>%
  rename(CamasUCI = UCI)

camas.last <- camas %>%
  filter(!is.na(CamasOcup)) %>%
  slice_tail()

pico30Marzo <- data.frame(Fecha = as.Date("2020-03-30"), CamasOcup = 2708, CamasUCI = 438)

camas %>%
  filter(Fecha > "2020-04-04") %>%
ggplot() +
  geom_line(aes(Fecha, CamasOcup), colour = "#377eb8", size = 2) +
  geom_line(aes(Fecha, CamasUCI), colour = "#e41a1c", size = 2) +
  ylim(0, NA) +
  labs(title = "Pacientes ingresados con COVID-19 en hospitales andaluces",
       caption = "https://tiny.cc/COVID19-Andalucia",
       x = "", y = "Camas ocupadas\n") +
  geom_point(data = pico30Marzo, aes(Fecha, CamasOcup), colour = "#377eb8", size = 2) +
  geom_point(data = pico30Marzo, aes(Fecha, CamasUCI), colour = "#e41a1c", size = 2) +
  geom_text(data = camas.last, 
            aes(Fecha - 3, CamasOcup + 250, label = paste0( "Total ", CamasOcup)),
            colour = "#377eb8") +
  geom_text(data = camas.last, 
            aes(Fecha - 3, CamasUCI + 200, label = paste0("UCI ", CamasUCI)), 
            colour = "#e41a1c") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b")
  

```


<br>



```{r curadas_Andalucia, fig.height=3, out.width='100%', eval=FALSE}

## Personas curadas

ggplot(datos.andal) +
  geom_col(aes(x = Fecha, y = Curados), 
            size = 1.5, fill = "#4daf4a") +
  ylim(0, NA) +
  #scale_x_date(limits = c(as.Date("2020-03-23"), NA)) +
  labs(x = "", y = "Nº Personas\n",
       title = "Personas curadas de COVID-19 diariamente en Andalucía",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_x_date(limits = c(as.Date("2020-03-01"), NA))

```


```{r curadas_provincias, out.width='100%', eval=FALSE}

ggplot(datos.provs) +
  facet_wrap(~Territorio, scales = "free_y", ncol = 2) +
  geom_col(aes(x = Fecha, y = Curados), 
            size = 1.5, fill = "#4daf4a") +
  ylim(0, NA) +
  labs(x = "", y = "Nº Personas\n",
       title = "Personas curadas diariamente en cada provincia",
       caption = "Nótese que, para facilitar la visualización de tendencias, la escala del eje vertical varía para cada provincia") +
  theme(axis.text.x = element_text(size = 8))

```


<br>



## Defunciones

<br>

```{r fallecidos_Andalucia, fig.height=3, out.width='100%'}

ggplot(datos.andal) +
  geom_col(aes(x = Fecha, y = Defunciones), fill = "grey40") +
  labs(x = "", y = "Nº Defunciones\n",
       title = "Defunciones diarias relacionadas con COVID-19 en Andalucía",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_y_continuous(limits = c(0, NA)) +
  scale_x_date(limits = c(as.Date("2020-03-01"), NA),
               date_breaks = "1 month", date_labels = "%b")

```

<br>

```{r fallecidos_Andalucia.14d, fig.height=3, out.width='100%'}

ggplot(datos.andal) +
  geom_col(aes(x = Fecha, y = Defunciones), fill = "grey40") +
  labs(x = "", y = "Nº Defunciones\n",
       title = "Defunciones diarias relacionadas con COVID-19 en Andalucía",
       subtitle = "Últimos 14 días",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_y_continuous(limits = c(0, NA)) +
  scale_x_date(limits = c(Sys.Date() - 16, NA), 
               date_breaks = "2 days", date_labels = "%d %b") 

```

<br>

**NOTA**: el retraso (de varios días) en las notificaciones hace que las curvas parezcan a menudo descendentes. Frecuentemente, en los días siguientes se añaden nuevas defunciones asignadas a fechas pasadas. Por tanto, **un aparente descenso en el número de defunciones en los últimos días no debe interpretarse como un descenso en la intensidad de la pandemia** hasta que los datos sean consolidados en los próximos días.

<br>

```{r fallecidos_provincias, eval = TRUE, out.width='100%', fig.height=6}
         
ggplot(datos.provs) +
  facet_wrap(~Territorio, ncol = 2) +  
  geom_col(aes(x = Fecha, y = Defunciones), 
            size = 1.5, fill = "grey40") +
  scale_y_continuous(limits = c(0, NA)) +
  #scale_x_date(limits = c(as.Date("2020-03-10"), NA)) +
  labs(x = "", y = "Nº Defunciones\n",
       title = "Defunciones diarias relacionadas con COVID-19 en cada provincia",
       subtitle = "Para facilitar la visualización de tendencias, la escala del eje vertical es diferente en cada provincia",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(axis.text.x = element_text(size = 8)) +
  scale_x_date(limits = c(as.Date("2020-03-01"), NA))

```

<br>





## Datos por municipio



<br>

```{r tabla.muni, out.width='100%', eval=FALSE}
# Esta tabla contiene los datos de casos confirmados y defunciones acumuladas por municipio. Se pueden realizar búsquedas en toda la tabla o filtrar valores en cada columna.

library(DT)

muni.data <- readr::read_csv("datos/municipios.csv", guess_max = 10000)
#muni.data$Provincia <- as.factor(muni.data$Provincia)

datatable(muni.data, rownames = FALSE, filter = "top")
```


Seleccione provincia y municipio para visualizar el número de casos confirmados y defunciones por municipio.

<br>

```{r shiny.muni, out.width='100%'}
include_app("https://frodsan.shinyapps.io/COVID19-Municipios-Andalucia/", 
            height = '600px')
```


<br>



## Distribucion por edad y sexo

Cada barra representa el % de casos, ingresos, o defunciones representado por personas de dicho sexo y categoría de edad.
<br>

```{r dist.edad.sexo, out.width='100%', fig.height=4}

casos.edad.sexo <- read_csv2("datos/edad.sexo/datos_casos_edad_sexo.csv",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = "."),
                          skip_empty_rows = TRUE) %>%
  select(-X5) %>%
  filter(Medida == "% pirámide") %>%
  mutate(Medida = "% Casos") %>%
  filter(!is.na(Edad))


hosp.edad.sexo <- read_csv2("datos/edad.sexo/datos_hosp_edad_sexo.csv",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = "."),
                          skip_empty_rows = TRUE) %>%
  select(-X5) %>%
  filter(Medida == "% pirámide") %>%
  mutate(Medida = "% Hospitalizaciones") %>%
  filter(!is.na(Edad))


uci.edad.sexo <- read_csv2("datos/edad.sexo/datos_uci_edad_sexo.csv",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = "."),
                          skip_empty_rows = TRUE) %>%
  select(-X5) %>%
  filter(Medida == "% pirámide") %>%
  mutate(Medida = "% UCI") %>%
  filter(!is.na(Edad))


def.edad.sexo <- read_csv2("datos/edad.sexo/datos_def_edad_sexo.csv",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = "."),
                          skip_empty_rows = TRUE) %>%
  select(-X5) %>%
  filter(Medida == "% pirámide") %>%
  mutate(Medida = "% Defunciones") %>%
  filter(!is.na(Edad)) %>%
  right_join(casos.edad.sexo[, c("Edad", "Sexo")], by = c("Edad", "Sexo")) %>%
  mutate(Medida = "% Defunciones")

# Sept 2020: ya no proveen esta información
# recup.edad.sexo <- read_csv2("datos/edad.sexo/datos_curados_edad_sexo.csv",
#                           locale = locale(date_names = "es", 
#                                           decimal_mark = ",",
#                                           grouping_mark = "."),
#                           skip_empty_rows = TRUE) %>%
#   select(-X5) %>%
#   filter(Medida == "% pirámide") %>%
#   mutate(Medida = "% Recuperados") %>%
#   filter(!is.na(Edad))


## Obtener etiquetas edades
library(stringr)
edades <- casos.edad.sexo %>%
  filter(Sexo == "Hombres") %>%
  mutate(edades = str_replace(Edad, "De ", "")) %>%
  mutate(edades = str_replace(edades, " a ", " - ")) %>%
  mutate(edades = str_replace(edades, " años", "")) %>%
  pull(edades)
  #mutate(edades = rev(edades))


## Juntar todas las variables

todo.edad.sexo <- bind_rows(casos.edad.sexo, 
                            hosp.edad.sexo,
                            uci.edad.sexo,
                            def.edad.sexo) %>%
  group_by(Sexo, Medida) %>%
  mutate(edades = factor(edades, levels = edades)) %>%
  ungroup() %>%
  mutate(Medida = factor(Medida, levels = c("% Casos", 
                                            "% Hospitalizaciones", "% UCI", "% Defunciones")))


## Fig hombres
todo.edad.sexo %>%
  filter(Sexo == "Hombres") %>%
ggplot() +
  facet_wrap(~Medida, nrow = 1) + 
  coord_flip() +
  geom_col(aes(x = edades, y = Valor), fill = "#ff7f00") +
  labs(x = "Edad (años)", y = "Porcentaje (%)", title = "Hombres",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(title = element_text(size = 15),
        axis.text.y = element_text(size = 8),
        strip.text = element_text(size = 9),
        axis.title = element_text(size = 10))


## Fig mujeres
todo.edad.sexo %>%
  filter(Sexo == "Mujeres") %>%
ggplot() +
  facet_wrap(~Medida, nrow = 1) + 
  coord_flip() +
  geom_col(aes(x = edades, y = Valor), fill = "#984ea3") +
  labs(x = "Edad (años)", y = "Porcentaje (%)", title = "Mujeres",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(title = element_text(size = 15),
        axis.text.y = element_text(size = 8),
        strip.text = element_text(size = 9),
        axis.title = element_text(size = 10)) +
  scale_y_continuous(breaks = seq(0, 10, 2))

```



<br>



## Letalidad

<br>

Aquí se representa, para cada sexo y franja de edad, la proporción de casos confirmados de COVID-19 que acaban en defunción (lo que en inglés se conoce como [Case Fatality Rate](https://en.wikipedia.org/wiki/Case_fatality_rate)). Estos valores sirven para tener una idea aproximada de la letalidad del virus, aunque la probabilidad individual de defunción depende de muchos otros factores (otras enfermedades, mejoras en los tratamientos, etc). Los valores que aquí se presentan además no tienen en cuenta las defunciones que pueden ocurrir en las próximas semanas de personas ahora infectadas. Ni las defunciones debidas a COVID-19 pero no diagnosticadas.

En cualquier caso, es evidente que la letalidad aumenta con la edad y es mayor en hombres que en mujeres. 

<br>

```{r letalidad, out.width='100%', fig.height=5}

casos.edad.sexo <- read_csv2("datos/edad.sexo/datos_casos_edad_sexo.csv",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = "."),
                          skip_empty_rows = TRUE) %>%
  select(-X5) %>%
  filter(Medida == "Confirmados PDIA") %>%
  filter(!is.na(Edad)) %>%
  rename(Casos = Valor) %>%
  select(-Medida)

def.edad.sexo <- read_csv2("datos/edad.sexo/datos_def_edad_sexo.csv",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = "."),
                          skip_empty_rows = TRUE) %>%
  select(-X5) %>%
  filter(Medida == "Fallecidos") %>%
  filter(!is.na(Edad))  %>%
  rename(Fallecidos = Valor) %>%
  select(-Medida)


cfr <- left_join(casos.edad.sexo, def.edad.sexo, by = c("Edad", "Sexo")) %>%
  mutate(Fallecidos = ifelse(is.na(Fallecidos), 0, Fallecidos)) %>%
  mutate(CFR = 100*Fallecidos/Casos) %>%
  filter(Edad != "De 100 y más años") %>%
  mutate(edades = factor(rep(edades[-1], each = 2), levels = edades[-1]))


ggplot(cfr) +
  facet_wrap(~Sexo, ncol = 2, scales = "free_x") +
  geom_col(aes(edades, CFR, fill = Sexo)) +
  coord_flip() +
  labs(y = "Porcentaje de casos que acaban en defunción (%)", x = "Edad\n", 
       title = "Letalidad por COVID-19 en Andalucía",
       subtitle = "Proporción de muertes respecto al número de casos confirmados\nen cada categoría de edad y sexo",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_fill_manual(values = c("#ff7f00", "#984ea3")) +
  theme(legend.position = "none")

```

<br>

## Comparacion con otras CCAA

<br>

Andalucía es de las comunidades autónomas que [menos test ha realizado](https://elpais.com/sociedad/2020-04-27/la-rioja-hace-siete-veces-mas-pruebas-pcr-por-habitante-que-andalucia.html) en relación al tamaño de su población (al menos hasta mediados de Abril). Por tanto el número de casos de COVID-19 puede estar notablemente infraestimado. De hecho, los primeros resultados del estudio serológico indican que [en Andalucía se han detectado probablemente menos del 10% de los contagios](https://www.eldiario.es/sociedad/porcentaje-poblacion-contagiada-explosivo-COVID-19_0_1026798481.html). En general, no debemos comparar el número de casos entre comunidades sin tener en cuenta la enorme variación en el número de test realizados.

<br>

```{r test.ccaa, out.width='100%'}
test.ccaa <- readxl::read_excel("datos/ntest_casos_ccaa_14Apr.xlsx")

set.seed(123)
ggplot(test.ccaa) +
  geom_point(aes(Ntest.pop, Casos.pop), size = 2) +
  ggrepel::geom_text_repel(aes(x = Ntest.pop, y = Casos.pop, label = CCAA),
                           size = 3, nudge_x = 10, nudge_y = 30) +
  scale_x_continuous(name = "\nNúmero de test por 100.000 habitantes",
                     limits = c(0, NA)) +
  scale_y_continuous(name = "Número de casos por 100.000 habitantes\n",
                     limits = c(0, NA)) +
  labs(title = "Número de casos detectados en relación al número de test\nrealizados por CC.AA.",
       caption = "Datos a 14 de Abril (Fuente: https://datos.civio.es)\nhttps://tiny.cc/COVID19-Andalucia") 
```

<br>
<br>


```{r confirmados.ccaa, fig.height=5, out.width='100%'}

ccaa.pcr <- readr::read_csv("https://raw.githubusercontent.com/datadista/datasets/master/COVID%2019/ccaa_covid19_datos_isciii_nueva_serie.csv", guess_max = 10000) 

library(plotly)

options(scipen = 1000)

ggplotly(
  ggplot(ccaa.pcr) +
  geom_line(aes(x = fecha, y = num_casos_prueba_pcr, group = ccaa), 
              colour = "grey80") +
  geom_line(aes(x = fecha, y = num_casos_prueba_pcr), 
            data = subset(ccaa.pcr, ccaa == "Andalucía"), 
            colour = "#ff7f00", size = 2) +
  #scale_y_log10() +
  labs(x = "", y = "Confirmados PCR\n",
       title = "Casos de COVID-19 confirmados por PCR en cada CCAA",
       #subtitle = "Escala logarítmica",
       caption = "https://tiny.cc/COVID19-Andalucia")
)

```




<br>

Realizado por [Francisco Rodríguez Sánchez](https://twitter.com/frod_san) a partir de los [datos](https://github.com/Pakillo/COVID19-Andalucia/tree/master/datos) ofrecidos por la Consejería de Salud y Familias de la Junta de Andalucía, la Fundación CIVIO y Datadista. Reproducción permitida con fines no comerciales citando la fuente (CC-BY-NC 4.0).



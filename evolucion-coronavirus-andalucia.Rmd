---
title: "Evolución del coronavirus (COVID-19) en Andalucía"
output: 
  html_document: 
    fig_caption: yes
    fig_height: 5
    fig_width: 7
    theme: flatly
    toc: no
    self_contained: no
    includes: 
      in_header: header.html
---

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-46538450-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-46538450-3');
</script>



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

# Garrick Adenbuie's gist to place TOC anywhere
# devtools::source_gist("c83e078bf8c81b035e32c3fc0cf04ee8", 
#                       filename = 'render_toc.R')
source("render_toc.R")
```

```{r pkgs, include=FALSE}
library(dplyr)
library(ggplot2)
#library(plotly)

mytheme <- theme_minimal(base_size = 12) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.caption = element_text(size = 8, face = "italic", colour = "grey60"),
        plot.subtitle = element_text(size = 9, face = "plain", colour = "grey50"),
        axis.ticks = element_line(colour = "grey80"),
        axis.ticks.length = unit(3, "pt"),
        strip.text = element_text(size = 12))
theme_set(mytheme)
```

<br>

Aquí se visualiza la evolución de la enfermedad del coronavirus (COVID-19) en Andalucía, según los [datos oficiales ofrecidos por la Consejería de Salud y Familias](https://www.juntadeandalucia.es/organismos/saludyfamilias/areas/salud-vida/paginas/Nuevo_Coronavirus.html). A diferencia de otras visualizaciones más extendidas, que representan datos acumulados en el tiempo, aquí se enfatizan las **variaciones diarias absolutas (no acumuladas)** en número de casos confirmados, personas ingresadas, curadas y fallecidas.

Los datos se actualizan diariamente. Tanto los datos como el código empleado para generar estas visualizaciones está disponible [aquí](https://github.com/Pakillo/COVID19-Andalucia).

Última actualización: `r Sys.Date()`

```{r}
render_toc("evolucion-coronavirus-andalucia.Rmd", base_level = 2, toc_depth = 1)
```




```{r}
library(readr)

#datos <- readxl::read_excel("datos_brutos.xlsx", sheet = "datos")

# A partir del 20 de Abril, usando datos de la Junta
# https://www.juntadeandalucia.es/institutodeestadisticaycartografia/badea/operaciones/consulta/anual/38228?CodOper=b3_2314&codConsulta=38228

datos <- readr::read_csv2("datos/datos_provincias_raw.csv", 
                          col_types = "Dcci-",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = ".",
                                          date_format = "%d/%m/%Y"),
                          skip_empty_rows = TRUE)

datos <- tidyr::pivot_wider(datos, names_from = "Medida", values_from = "Valor") %>%
  rename(UCI = `Total UCI`)


datos <- datos %>%
  arrange(Fecha) %>%
  group_by(Territorio) %>%
  mutate(Confirmados.new = Confirmados - lag(Confirmados),
         Hospitalizados.new = Hospitalizados - lag(Hospitalizados),
         UCI.new =  UCI - lag(UCI),
         Fallecimientos.new = Fallecimientos - lag(Fallecimientos),
         #Altas.dia = Altas.acum - lag(Altas.acum),
         Curados.new = Curados - lag(Curados)) %>%
  ungroup()

datos <- dplyr::filter(datos, Territorio != "España")


# checks
library(assertr)

# datos %>%
#   assert(within_bounds(0, Inf), Confirmados.new:Curados.new, 
#          error_fun = error_report)  

write_csv(datos, "datos/datos_provincias_clean.csv")

```


```{r include=FALSE}
provs <- datos %>%
  filter(Territorio != "Andalucía")

provs %>%
  verify(length(unique(Territorio)) == 8, success_fun = success_logical)

```


```{r}

test.andal <- readxl::read_excel("datos/test_Andalucia.xlsx")
test.andal$Fecha <- as.Date(test.andal$Fecha)

andal <- datos %>%
  filter(Territorio == "Andalucía") %>%
  left_join(test.andal[, c("Fecha", "Ntest.dia")], by = "Fecha") %>%
  group_by(Fecha) %>%
  mutate(Prop.positivos = 100 * (Confirmados.new / Ntest.dia)) %>%
  ungroup()


# prop.ci <- function(pos, n) {
#   # from Gelman & Hill book, p. 18
#   estimate <- pos/n
#   se <- sqrt(estimate * (1 - estimate) / n)
#   int.99 <- estimate + qnorm(c(.005,.995)) * se
#   int.99
# }


```

<br>




## Casos confirmados

<br>

```{r casos_Andalucia, fig.height=4, out.width='100%'}

ggplot(andal) +
  geom_col(aes(x = Fecha, y = Confirmados.new), 
            fill = "#ff7f00") +
  geom_line(aes(x = Fecha, y = Ntest.dia), 
            size = 1, colour = "grey70") + 
  scale_y_continuous(limits = c(0, NA), n.breaks = 6) +
  labs(x = "", y = "Nuevas detecciones\n",
       title = "Casos de COVID-19 confirmados diariamente en Andalucía",
       subtitle = "La línea gris representa el número de test realizados diariamente",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(panel.grid.minor.y = element_line(size = rel(0.5)))

```

<br>

Debe tenerse en cuenta que el [número de casos confirmados depende en gran medida del número de test realizados](https://ourworldindata.org/covid-testing). Por tanto, un aumento o disminución en el número de casos confirmados cada día puede deberse a haber realizado más o menos tests, no a variaciones en la incidencia de la enfermedad. 

<br>



```{r ncasos.ntest, out.width='100%', fig.height=4}
ggplot(andal) +
  geom_point(aes(Ntest.dia, Confirmados.new), 
             size = 3, colour = "#ff7f00") +
  scale_y_continuous(limits = c(0, NA), 
                     name = "Número de casos confirmados\n") +
  scale_x_continuous(limits = c(0, NA),
                     name = "\nNúmero de test realizados") +
  labs(title = "Relación entre el número de casos confirmados\ny el número de test realizados diariamente",
       caption = "https://tiny.cc/COVID19-Andalucia")
```

<br>
<br>

Andalucía es de las comunidades autónomas que menos test ha realizado en relación al tamaño de su población (al menos hasta mediados de Abril). Por tanto el número de casos de COVID-19 puede estar notablemente infraestimado. No debemos comparar el número de casos entre comunidades sin tener en cuenta la enorme variación en el número de test realizados.

<br>

```{r test.ccaa, out.width='100%'}
test.ccaa <- readxl::read_excel("datos/ntest_casos_ccaa_14Apr.xlsx")

ggplot(test.ccaa) +
  geom_point(aes(Ntest.pop, Casos.pop), size = 2) +
  ggrepel::geom_text_repel(aes(x = Ntest.pop, y = Casos.pop, label = CCAA),
                           size = 3, nudge_x = 10, nudge_y = 30) +
  scale_x_continuous(name = "\nNúmero de test por 100.000 habitantes",
                     limits = c(0, NA)) +
  scale_y_continuous(name = "Número de casos por 100.000 habitantes\n",
                     limits = c(0, NA)) +
  labs(title = "Número de casos detectados en relación al número de habitantes\ny test realizados por CC.AA.",
       caption = "Datos a 14 de Abril (Fuente: https://datos.civio.es)\nhttps://tiny.cc/COVID19-Andalucia") 
```

<br>

La proporción de casos positivos respecto al total de test realizados también [puede informarnos](https://www.theatlantic.com/technology/archive/2020/04/us-coronavirus-outbreak-out-control-test-positivity-rate/610132/) sobre la incidencia de la enfermedad: 

<br>

```{r prop.positivos, fig.height=4, out.width = '100%'}

sec.axis.factor = 30

ggplot(andal) +
  # geom_ribbon(aes(x = Fecha, ymin = prop.ci.low, ymax = prop.ci.up),
  #             fill = "#ff7f00", alpha = 0.3) +
  geom_col(aes(x = Fecha, y = Prop.positivos), 
            size = 2, fill = "#ff7f00") +
  geom_line(aes(x = Fecha, y = (Ntest.dia/sec.axis.factor)), 
            colour = "grey70", size = 1.5) +
  # geom_text(aes(x = Fecha, y = 5, label = Ntest.dia), 
  #           colour = "#ff7f00", alpha = 0.8) +
  scale_y_continuous(limits = c(0, 100), 
                     sec.axis = sec_axis(trans = ~ ((.*sec.axis.factor)), 
                                         breaks = seq(0, 3000, by = 500),
                                         name = "Número de test\n")) +
  scale_x_date(limits = c(as.Date("2020-03-26"), NA)) +
  labs(x = "", y = "Porcentaje de tests positivos\n",
       title = "Porcentaje de tests que dan positivo en Andalucía",
       subtitle = "La línea gris representa el número de test realizados diariamente (eje derecho)",
       caption = "https://tiny.cc/COVID19-Andalucia")


```


<br>
<br>

```{r casos_provincias, out.width = '100%', fig.height=6}

ggplot(provs) +
  facet_wrap(~Territorio, scales = "free_y", ncol = 2) +
  geom_col(aes(x = Fecha, y = Confirmados.new), 
            size = 1.5, fill = "#ff7f00") +
  ylim(0, NA) +
  labs(x = "", y = "Nuevas detecciones\n",
       title = "Casos de COVID-19 confirmados diariamente en cada provincia",
       subtitle = "Para facilitar la visualización de tendencias la escala del eje vertical es diferente cada provincia",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(axis.text.x = element_text(size = 8))

```


<br>


### Casos confirmados por Distrito Sanitario 


```{r eval=FALSE}
# 
# distritos.old <- gsheet::gsheet2tbl("https://docs.google.com/spreadsheets/d/1vH3y_4bL9n1sXOQjA91m8eqfbpCI-a8KV3cWXfQY3cI")
# 
# distritos <- distritos %>%
#   group_by(nombre) %>%
#   mutate(casos.dia = confirmados - lag(confirmados)) %>%
#   mutate(casos.dia = ifelse(fecha == as.Date("2020-04-11"), NA, casos.dia))

#stopifnot(distritos$casos.dia >=0)

```




```{r include = FALSE}

distritos <- readxl::read_excel("datos/distritos_sanitarios.xlsx")

distri.data <- read_csv("datos/datos_distritos_confirmados.csv",
                        col_types = "Dccccci")

if (!fecha.distri %in% distri.data$Fecha) {
  
  distri.data.new <- readr::read_csv2("datos/datos_distritos_confirmados_dia.csv", 
                                      col_types = "cccci-",
                                      locale = locale(date_names = "es", 
                                                      decimal_mark = ",",
                                                      grouping_mark = ".",
                                                      date_format = "%d/%m/%Y"),
                                      skip_empty_rows = TRUE)
  
  distri.data.new <- distri.data.new %>%
    mutate(Fecha = fecha.distri) %>%
    rename(Casos = Valor) %>%
    dplyr::select(-Medida) %>%
    dplyr::select(Fecha, everything()) 
  
  
  # checks
  distri.data.new %>%
    verify(names(.) == c("Fecha", "Territorio", "Edad", "Sexo", "Casos")) %>%
    verify(sort(unique(.$Territorio)) == sort(distritos$Territorio)) %>%
    assert(within_bounds(0, Inf), Casos)
  
  # join
  distri.data.new <- distri.data.new %>%
    left_join(distritos, by = "Territorio") %>%
    dplyr::select(Fecha, Territorio, nombre.corto, provincia, everything()) %>%
    arrange(Fecha, provincia, Territorio)
  
  
  # add to former dataset
  distri.data <- bind_rows(distri.data, distri.data.new)
  
  # save
  write_csv(distri.data, "datos/datos_distritos_confirmados.csv")
  
}

```

```{r eval=FALSE}
# ## 23-04-2020: La Junta cambia nombre de distritos con nombre == a provincia
# distri.data <- distri.data %>%
#   mutate(Territorio = case_when(
#     Territorio == "Almería" ~ "Almería (distrito)",
#     Territorio == "Córdoba" ~ "Córdoba (distrito)",
#     Territorio == "Granada" ~ "Granada (distrito)",
#     Territorio == "Jaén" ~ "Jaén (distrito)",
#     Territorio == "Málaga" ~ "Málaga (distrito)",
#     Territorio == "Sevilla" ~ "Sevilla (distrito)",
#     TRUE ~ Territorio
#   ))

# distri.data <- distri.data %>%
#   mutate(nombre.corto = ifelse(nombre.corto == "Axarquia", "Axarquía", nombre.corto))

# distri.data <- distri.data %>%
#   filter(Fecha != "2020-04-22")
```



```{r casos.distri, out.width='100%', fig.height=7}

distri.data <- read_csv("datos/datos_distritos_confirmados.csv",
                        col_types = "Dccccci")

distri.data2plot <- distri.data %>%
  filter(Edad == "TOTAL", Sexo == "Ambos sexos") %>%
  filter(Fecha > as.Date("2020-04-10")) %>%
  group_by(Territorio) %>%
  mutate(Casos.new = Casos - lag(Casos)) %>%
  ungroup() %>%
  mutate(Casos.new = ifelse(Fecha == as.Date("2020-04-11"), NA, Casos.new))

distri.last <- dplyr::filter(distri.data2plot, Fecha == max(Fecha))

set.seed(5)

ggplot(distri.data2plot) +
  aes(x = Fecha, y = Casos.new) +
  facet_wrap(~provincia, ncol = 2) +
  geom_line(aes(group = nombre.corto, colour = nombre.corto), size = 1.5) +
  theme(legend.position = "none") +
  geom_point(data = distri.last, aes(colour = nombre.corto), size = 1.5) +
  scale_color_manual(values = sample(colorRampPalette(RColorBrewer::brewer.pal(n = 9, "Set1")[-6])(100))) +
  ggrepel::geom_text_repel(data = distri.last,
                           aes(label = nombre.corto, colour = nombre.corto), 
                           size = 2.5, nudge_x = 0.4, 
                           segment.size = 0.2, segment.alpha = 0.5) +
  scale_x_date(expand = expansion(mult = c(0, 0.5))) +
  labs(x = "", y = "Casos confirmados\n",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(strip.text = element_text(size = 12))

```


Este mapa muestra los casos confirmados con fecha 6 de Abril. La Junta de Andalucía ha comenzado a visualizar los datos diarios por Distrito Sanitario y municipio [aquí](http://www.juntadeandalucia.es/institutodeestadisticaycartografia/salud/COVID19.html).

```{r mapa_distritos, out.width='100%'}
casos.dist <- readxl::read_excel("datos/datos_brutos.xlsx", sheet = "distritos")

library(sf)

distritos <- st_read("Distritos/Distritos_2018.shp", 
                     stringsAsFactors = FALSE, quiet = TRUE) %>%
  mutate(CODIST = as.numeric(CODIST))

casos.dist <- left_join(select(distritos, CODIST, nombre),
                        select(casos.dist, CODIST, nombre, casos, fecha),
                        by = c("CODIST", "nombre"))


library(mapview)
mapviewOptions(legend.pos = "bottomleft")

mapview(casos.dist, zcol = "casos", 
        col.regions = colorRampPalette(RColorBrewer::brewer.pal(9, "YlOrRd")),
        alpha.regions = 0.9,
        map.types = "CartoDB.Positron",
        layer.name = "Casos",
        popup = leafpop::popupTable(casos.dist, 
                                    zcol = c("nombre", "casos", "fecha"), 
                           row.numbers = FALSE, feature.id = FALSE)) 

# ggplot(casos.dist) +
#   geom_sf(aes(fill = casos)) +
#   scale_fill_distiller(type = "seq", palette = "YlGnBu", direction = 1)
        
```




```{r seguimiento_Andalucía, fig.height=3, out.width='100%',eval=FALSE}

ggplot(andal) +
  geom_line(aes(x = Fecha, y = Seguimiento), 
            size = 2, colour = "#a65628") +
  ylim(0, max(andal$Seguimiento)) +
  scale_x_datetime(limits = c(min(andal$Fecha[!is.na(andal$Seguimiento)]),
                          max(andal$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Personas en seguimiento activo por COVID-19 en Andalucía")

```


```{r seguimiento_provincias, out.width='100%', eval=FALSE}

ggplot(datos) +
  facet_wrap(~Provincia, scales = "free_y", ncol = 2) +
  geom_line(aes(x = Fecha, y = Seguimiento), 
            size = 1.5, colour = "#a65628") +
  ylim(0, max(datos$Seguimiento)) +
  scale_x_datetime(limits = c(min(datos$Fecha[!is.na(datos$Seguimiento)]),
                          max(datos$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Personas en seguimiento activo en cada provincia",
       caption = "Nótese que, para facilitar la visualización de tendencias, la escala del eje vertical varía para cada provincia") +
  theme(axis.text.x = element_text(size = 8))

```


<br>


## Ingresos en centros hospitalarios

<br>


```{r ingresos_Andalucia, fig.height=3, out.width='100%'}

ggplot(andal) +
  geom_line(aes(x = Fecha, y = Hospitalizados.new), 
            size = 2, colour = "#e41a1c") +
  ylim(0, NA) +
  scale_x_date(limits = c(as.Date("2020-03-15"), NA)) +
  labs(x = "", y = "Nº Personas\n",
       title = "Hospitalizaciones diarias con COVID-19 en Andalucía",
       caption = "https://tiny.cc/COVID19-Andalucia")

```


<br>
<br>


```{r ingresos_provincias, out.width='100%', fig.height=6}

ggplot(provs) +
  facet_wrap(~Territorio, scales = "free_y", ncol = 2) +
  geom_line(aes(x = Fecha, y = Hospitalizados.new), 
            size = 1.5, colour = "#e41a1c") +
  ylim(0, NA) +
  scale_x_date(limits = c(as.Date("2020-03-15"), NA)) +
  # scale_x_datetime(limits = c(as.POSIXct("2020-03-23", tz = "UTC"),
  #                         max(datos$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Hospitalizaciones diarias con COVID-19 en cada provincia",
       subtitle = "Para facilitar la visualización de tendencias la escala del eje vertical es diferente en cada provincia",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(axis.text.x = element_text(size = 8))

```


<br>


## Ingresos en cuidados intensivos (UCI)

<br>


```{r uci_Andalucia, fig.height=3, out.width='100%'}

ggplot(andal) +
  geom_line(aes(x = Fecha, y = UCI.new), 
            size = 2, colour = "#a65628") +
  ylim(0, max(andal$UCI.new)) +
  scale_x_date(limits = c(as.Date("2020-03-27"), NA)) +
  # scale_x_datetime(limits = c(min(andal$Fecha[!is.na(andal$UCI.dia)]),
  #                         max(andal$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Ingresos diarios en UCI con COVID-19 en Andalucía",
       caption = "https://tiny.cc/COVID19-Andalucia")

```


<br>
<br>


```{r uci_provincias, out.width='100%', eval=FALSE}

ggplot(provs) +
  facet_wrap(~Territorio, scales = "free_y", ncol = 2) +
  geom_line(aes(x = Fecha, y = UCI.new), 
            size = 1.5, colour = "#a65628") +
  ylim(0, NA) +
  scale_x_date(limits = c(as.Date("2020-03-27"), NA)) +
  # scale_x_datetime(limits = c(min(datos$Fecha[!is.na(datos$UCI.dia)]),
  #                         max(datos$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Ingresos diarios en cuidados intensivos en cada provincia",
       subtitle = "Para facilitar la visualización de tendencias, la escala del eje vertical es diferente cada provincia",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(axis.text.x = element_text(size = 8))

```




```{r altas_Andalucía, fig.height=3, out.width='100%', eval=FALSE}

ggplot(andal) +
  geom_line(aes(x = Fecha, y = Altas.dia), 
            size = 2, colour = "#377eb8") +
  ylim(0, max(andal$Altas.dia)) +
  scale_x_datetime(limits = c(andal$Fecha[13],
                          max(andal$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Altas hospitalarias en Andalucía")

```



```{r altas_provincias, out.width='100%', eval=FALSE}

ggplot(datos) +
  facet_wrap(~Provincia, scales = "free_y", ncol = 2) +
  geom_line(aes(x = Fecha, y = Altas.dia), 
            size = 1.5, colour = "#377eb8") +
  ylim(0, max(datos$Altas.dia)) +
  scale_x_datetime(limits = c(andal$Fecha[13],
                          max(datos$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Altas hospitalarias en cada provincia",
       caption = "Nótese que, para facilitar la visualización de tendencias, la escala del eje vertical varía para cada provincia") +
  theme(axis.text.x = element_text(size = 8))

```


<br>


## Personas curadas

<br>


```{r curadas_Andalucia, fig.height=3, out.width='100%'}

ggplot(andal) +
  geom_line(aes(x = Fecha, y = Curados.new), 
            size = 2, colour = "#4daf4a") +
  ylim(0, NA) +
  scale_x_date(limits = c(as.Date("2020-03-23"), NA)) +
  labs(x = "", y = "Nº Personas\n",
       title = "Personas curadas de COVID-19 diariamente en Andalucía",
       caption = "https://tiny.cc/COVID19-Andalucia")

```


<br>
<br>


```{r curadas_provincias, out.width='100%', eval=FALSE}

ggplot(datos) +
  facet_wrap(~Provincia, scales = "free_y", ncol = 2) +
  geom_line(aes(x = Fecha, y = Curadas.dia), 
            size = 1.5, colour = "#4daf4a") +
  ylim(0, max(datos$Curadas.dia)) +
  scale_x_datetime(limits = c(andal$Fecha[13],
                          max(datos$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Personas curadas diariamente en cada provincia",
       caption = "Nótese que, para facilitar la visualización de tendencias, la escala del eje vertical varía para cada provincia") +
  theme(axis.text.x = element_text(size = 8))

```


<br>



## Fallecimientos

<br>

```{r fallecidos_Andalucia, fig.height=3, out.width='100%'}

ggplot(andal) +
  geom_line(aes(x = Fecha, y = Fallecimientos.new), 
            size = 2, colour = "grey20") +
  labs(x = "", y = "Nº Fallecidos\n",
       title = "Fallecimientos diarios relacionados con COVID-19 en Andalucía",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_y_continuous(limits = c(0, NA)) 

```

<br>
<br>

```{r fallecidos_provincias, eval = TRUE, out.width='100%', fig.height=6}
         
ggplot(provs) +
  facet_wrap(~Territorio, ncol = 2, scales = "free_y") +  
  geom_line(aes(x = Fecha, y = Fallecimientos.new), 
            size = 1.5, colour = "grey20") +
  scale_y_continuous(limits = c(0, NA)) +
  scale_x_date(limits = c(as.Date("2020-03-10"), NA)) +
  labs(x = "", y = "Nº Fallecidos\n",
       title = "Fallecimientos diarios relacionados con COVID-19 en cada provincia",
       subtitle = "Para facilitar la visualización de tendencias, la escala del eje vertical es diferente en cada provincia",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(axis.text.x = element_text(size = 8))
```

<br>


Realizado por [Francisco Rodríguez Sánchez](https://twitter.com/frod_san) a partir de los [datos]((https://www.juntadeandalucia.es/organismos/saludyfamilias/areas/salud-vida/paginas/Nuevo_Coronavirus.html)) ofrecidos por la Consejería de Salud y Familias de la Junta de Andalucía.


---
title: "Evolución del coronavirus (COVID-19) en Andalucía"
output: 
  html_document: 
    fig_caption: yes
    fig_height: 5
    fig_width: 7
    theme: flatly
    toc: no
    self_contained: no
    includes: 
      in_header: header.html
---

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-46538450-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-46538450-3');
</script>



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)

# Garrick Adenbuie's gist to place TOC anywhere
devtools::source_gist("c83e078bf8c81b035e32c3fc0cf04ee8", 
                      filename = 'render_toc.R')
```

```{r pkgs, include=FALSE}
library(dplyr)
library(ggplot2)
#library(plotly)

mytheme <- theme_minimal(base_size = 12) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.caption = element_text(size = 7, face = "italic", colour = "grey60"),
        axis.ticks = element_line(colour = "grey80"),
        axis.ticks.length = unit(3, "pt"))
theme_set(mytheme)
```

<br>

Aquí se visualiza la evolución de la enfermedad del coronavirus (COVID-19) en Andalucía, según los [datos oficiales ofrecidos por la Consejería de Salud y Familias](https://www.juntadeandalucia.es/organismos/saludyfamilias/areas/salud-vida/paginas/Nuevo_Coronavirus.html). A diferencia de otras visualizaciones más extendidas, que representan datos acumulados en el tiempo, aquí se enfatizan las **variaciones diarias absolutas (no acumuladas)** en número de casos detectados, personas ingresadas, curadas y número de fallecimientos.

Los datos se actualizan diariamente. Tanto los datos como el código empleado para generar estas visualizaciones está disponible [aquí](https://github.com/Pakillo/COVID19-Andalucia).

Última actualización: `r Sys.Date()`

```{r}
render_toc("evolucion-coronavirus-andalucia.Rmd")
```




```{r}
datos <- readxl::read_excel("datos_brutos.xlsx", sheet = "datos")
```

```{r}
datos <- datos %>%
  group_by(Provincia) %>%
  mutate(Positivos.dia = Positivos.acum - lag(Positivos.acum),
         Fallecimientos.dia = Fallecimientos.acum - lag(Fallecimientos.acum),
         Altas.dia = Altas - lag(Altas),
         Curadas.dia = Curados - lag(Curados))
```


```{r}
andal <- datos %>%
  group_by(Fecha) %>%
  summarise(Positivos.dia = sum(Positivos.dia),
            Ingresados = sum(Ingresados),
            UCI = sum(UCI),
            Seguimiento = sum(Seguimiento),
            Fallecimientos.dia = sum(Fallecimientos.dia),
            Altas.dia = sum(Altas.dia),
            Curadas.dia = sum(Curadas.dia))
```

<br>

## Casos detectados

<br>

Debe tenerse en cuenta que el número de casos detectados depende en gran medida del número de test realizados. Por tanto, un aumento o disminución en el número de casos detectados cada día puede deberse a haber realizado más o menos tests, no a variaciones en la incidencia de la enfermedad.

<br>

```{r casos_Andalucía, fig.height=3, out.width='100%'}

ggplot(andal) +
  geom_line(aes(x = Fecha, y = Positivos.dia), 
            size = 2, colour = "#ff7f00") +
  ylim(0, max(andal$Positivos.dia)) +
  scale_x_datetime(limits = c(min(andal$Fecha[!is.na(andal$Positivos.dia)]),
                          max(andal$Fecha))) +
  labs(x = "", y = "Nuevas detecciones\n",
       title = "Nuevos casos de COVID-19 detectados diariamente en Andalucía")

```


<br>
<br>


```{r casos_provincias, out.width = '100%'}

ggplot(datos) +
  facet_wrap(~Provincia, scales = "free_y", ncol = 2) +
  geom_line(aes(x = Fecha, y = Positivos.dia), 
            size = 1.5, colour = "#ff7f00") +
  ylim(0, max(datos$Positivos.dia)) +
  scale_x_datetime(limits = c(min(datos$Fecha[!is.na(datos$Positivos.dia)]),
                          max(datos$Fecha))) +
  labs(x = "", y = "Nuevas detecciones\n",
       title = "Nuevos casos de COVID-19 detectados diariamente en cada provincia",
       caption = "Nótese que, para facilitar la visualización de tendencias, la escala del eje vertical varía para cada provincia") +
  theme(axis.text.x = element_text(size = 8))

```


<br>
<br>

```{r prop.positivos, out.width = '100%', eval=FALSE}

prop.ci <- function(pos, n) {
  # from Gelman & Hill book, p. 18
  estimate <- pos/n
  se <- sqrt(estimate * (1 - estimate) / n)
  int.95 <- estimate + qnorm(c(.025,.975)) * se
  int.95

}

test.andal <- readxl::read_excel("datos_brutos.xlsx", sheet = "test-Andal")

andal <- andal %>%
  left_join(test.andal[, c("Fecha", "Ntest.dia")], by = "Fecha") %>%
  group_by(Fecha) %>%
  mutate(Prop.positivos = Positivos.dia / Ntest.dia,
         prop.ci.low = prop.ci(Positivos.dia, Ntest.dia)[1],
         prop.ci.up = prop.ci(Positivos.dia, Ntest.dia)[2])


ggplot(andal) +
  geom_ribbon(aes(x = Fecha, ymin = prop.ci.low, ymax = prop.ci.up),
              fill = "steelblue", alpha = 0.3) +
  geom_line(aes(x = Fecha, y = Prop.positivos), 
            size = 2, colour = "steelblue") +
  ylim(0, max(andal$Prop.positivos)) +
  scale_x_datetime(limits = c(min(andal$Fecha[!is.na(andal$Prop.positivos)]),
                          max(andal$Fecha))) +
  labs(x = "", y = "Proporción de tests positivos\n",
       title = "Proporción de tests que dan positivo")



```

<br>

```{r seguimiento_Andalucía, fig.height=3, out.width='100%',eval=FALSE}

ggplot(andal) +
  geom_line(aes(x = Fecha, y = Seguimiento), 
            size = 2, colour = "#a65628") +
  ylim(0, max(andal$Seguimiento)) +
  scale_x_datetime(limits = c(min(andal$Fecha[!is.na(andal$Seguimiento)]),
                          max(andal$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Personas en seguimiento activo por COVID-19 en Andalucía")

```


```{r seguimiento_provincias, out.width='100%', eval=FALSE}

ggplot(datos) +
  facet_wrap(~Provincia, scales = "free_y", ncol = 2) +
  geom_line(aes(x = Fecha, y = Seguimiento), 
            size = 1.5, colour = "#a65628") +
  ylim(0, max(datos$Seguimiento)) +
  scale_x_datetime(limits = c(min(datos$Fecha[!is.na(datos$Seguimiento)]),
                          max(datos$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Personas en seguimiento activo en cada provincia",
       caption = "Nótese que, para facilitar la visualización de tendencias, la escala del eje vertical varía para cada provincia") +
  theme(axis.text.x = element_text(size = 8))

```


<br>


## Personas ingresadas en centros sanitarios

<br>

Número neto de personas que permanecen ingresadas en centros sanitarios de Andalucía cada día, teniendo en cuenta tanto los nuevos ingresos como las altas hospitalarias.

<br>


```{r ingresados_Andalucía, fig.height=3, out.width='100%'}

ggplot(andal) +
  geom_line(aes(x = Fecha, y = Ingresados), 
            size = 2, colour = "#e41a1c") +
  ylim(0, max(andal$Ingresados)) +
  scale_x_datetime(limits = c(min(andal$Fecha[!is.na(andal$Ingresados)]),
                          max(andal$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Personas ingresadas por COVID-19 en Andalucía")

```


<br>
<br>


```{r ingresados_provincias, out.width='100%'}

ggplot(datos) +
  facet_wrap(~Provincia, scales = "free_y", ncol = 2) +
  geom_line(aes(x = Fecha, y = Ingresados), 
            size = 1.5, colour = "#e41a1c") +
  ylim(0, max(datos$Ingresados)) +
  scale_x_datetime(limits = c(min(datos$Fecha[!is.na(datos$Ingresados)]),
                          max(datos$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Personas ingresadas en cada provincia",
       caption = "Nótese que, para facilitar la visualización de tendencias, la escala del eje vertical varía para cada provincia") +
  theme(axis.text.x = element_text(size = 8))

```


<br>


## Personas ingresadas en cuidados intensivos (UCI)

<br>

Número neto de personas que permanecen ingresadas en cuidados intensivos (UCI). 

<br>



```{r uci_Andalucía, fig.height=3, out.width='100%'}

ggplot(andal) +
  geom_line(aes(x = Fecha, y = UCI), 
            size = 2, colour = "#a65628") +
  ylim(0, max(andal$UCI)) +
  scale_x_datetime(limits = c(min(andal$Fecha[!is.na(andal$UCI)]),
                          max(andal$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Personas en cuidados intensivos con COVID-19 en Andalucía")

```


<br>
<br>


```{r uci_provincias, out.width='100%'}

ggplot(datos) +
  facet_wrap(~Provincia, scales = "free_y", ncol = 2) +
  geom_line(aes(x = Fecha, y = UCI), 
            size = 1.5, colour = "#a65628") +
  ylim(0, max(datos$UCI)) +
  scale_x_datetime(limits = c(min(datos$Fecha[!is.na(datos$UCI)]),
                          max(datos$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Personas ingresadas en cuidados intensivos en cada provincia",
       caption = "Nótese que, para facilitar la visualización de tendencias, la escala del eje vertical varía para cada provincia") +
  theme(axis.text.x = element_text(size = 8))

```




```{r altas_Andalucía, fig.height=3, out.width='100%', eval=FALSE}

ggplot(andal) +
  geom_line(aes(x = Fecha, y = Altas.dia), 
            size = 2, colour = "#377eb8") +
  ylim(0, max(andal$Altas.dia)) +
  scale_x_datetime(limits = c(andal$Fecha[13],
                          max(andal$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Altas hospitalarias en Andalucía")

```



```{r altas_provincias, out.width='100%', eval=FALSE}

ggplot(datos) +
  facet_wrap(~Provincia, scales = "free_y", ncol = 2) +
  geom_line(aes(x = Fecha, y = Altas.dia), 
            size = 1.5, colour = "#377eb8") +
  ylim(0, max(datos$Altas.dia)) +
  scale_x_datetime(limits = c(andal$Fecha[13],
                          max(datos$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Altas hospitalarias en cada provincia",
       caption = "Nótese que, para facilitar la visualización de tendencias, la escala del eje vertical varía para cada provincia") +
  theme(axis.text.x = element_text(size = 8))

```


<br>


## Personas curadas

<br>


```{r curadas_Andalucía, fig.height=3, out.width='100%'}

ggplot(andal) +
  geom_line(aes(x = Fecha, y = Curadas.dia), 
            size = 2, colour = "#4daf4a") +
  ylim(0, max(andal$Curadas.dia)) +
  scale_x_datetime(limits = c(andal$Fecha[13],
                          max(andal$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Personas curadas de COVID-19 en Andalucía")

```


<br>
<br>


```{r curadas_provincias, out.width='100%', eval=FALSE}

ggplot(datos) +
  facet_wrap(~Provincia, scales = "free_y", ncol = 2) +
  geom_line(aes(x = Fecha, y = Curadas.dia), 
            size = 1.5, colour = "#4daf4a") +
  ylim(0, max(datos$Curadas.dia)) +
  scale_x_datetime(limits = c(andal$Fecha[13],
                          max(datos$Fecha))) +
  labs(x = "", y = "Nº Personas\n",
       title = "Personas curadas en cada provincia",
       caption = "Nótese que, para facilitar la visualización de tendencias, la escala del eje vertical varía para cada provincia") +
  theme(axis.text.x = element_text(size = 8))

```


<br>



## Fallecimientos

<br>

```{r fallecidos_Andalucia, fig.height=3, out.width='100%'}

ggplot(andal) +
  geom_line(aes(x = Fecha, y = Fallecimientos.dia), 
            size = 2, colour = "grey20") +
  labs(x = "", y = "Nº Fallecidos\n",
       title = "Fallecimientos diarios relacionados con COVID-19 en Andalucía") +
  scale_y_continuous(limits = c(0, max(andal$Fallecimientos.dia, na.rm = TRUE))) +
  scale_x_datetime(limits = c(min(andal$Fecha[!is.na(andal$Fallecimientos.dia)]),
                          max(andal$Fecha)))

```

<br>
<br>

```{r fallecidos_provincias, eval = TRUE, out.width='100%'}
         
ggplot(datos) +
  facet_wrap(~Provincia, ncol = 2, scales = "free_y") +  
  geom_line(aes(x = Fecha, y = Fallecimientos.dia), 
            size = 1.5, colour = "grey20") +
  scale_y_continuous(limits = c(0, max(datos$Fallecimientos.dia, na.rm = TRUE))) +
  scale_x_datetime(limits = c(min(datos$Fecha[!is.na(datos$Fallecimientos.dia)]),
                          max(datos$Fecha))) +
  labs(x = "", y = "Nº Fallecidos\n",
       title = "Fallecimientos diarios relacionados con COVID-19 en cada provincia",
       caption = "Nótese que, para facilitar la visualización de tendencias, la escala del eje vertical varía para cada provincia") +
  theme(axis.text.x = element_text(size = 8))
```

<br>


Realizado por [Francisco Rodríguez Sánchez](https://twitter.com/frod_san) a partir de los [datos]((https://www.juntadeandalucia.es/organismos/saludyfamilias/areas/salud-vida/paginas/Nuevo_Coronavirus.html)) ofrecidos por la Consejería de Salud y Familias de la Junta de Andalucía.

